@* Component hiển thị thẻ sản phẩm trong danh sách *@
@inject IStoreCartService CartService
@inject IProductClientService ProductService
@inject NavigationManager Navigation

<div class="product-card">
    <div class="product-image">
        <img src="@ImageUrl" alt="@ProductName" />
        @if (HasPromotion)
        {
            <span class="promotion-badge">KHUYẾN MÃI</span>
        }
    </div>
    <div class="product-info">
        <h3 class="product-name">@ProductName</h3>
        <div class="product-price">
            @if (OriginalPrice.HasValue && OriginalPrice.Value > Price)
            {
                <span class="original-price">@OriginalPrice.Value.ToString("N0") đ</span>
            }
            <span class="current-price">@Price.ToString("N0") đ</span>
        </div>
        <button class="btn btn-primary btn-add-to-cart" @onclick="AddToCart" disabled="@isAdding">
            @if (isAdding)
            {
                <text>Đang thêm...</text>
            }
            else
            {
                <text>Thêm vào giỏ</text>
            }
        </button>
    </div>
</div>

@code {
    [Parameter] public int ProductId { get; set; }
    [Parameter] public string ProductName { get; set; } = "";
    [Parameter] public string ImageUrl { get; set; } = "";
    [Parameter] public decimal Price { get; set; }
    [Parameter] public decimal? OriginalPrice { get; set; }
    [Parameter] public bool HasPromotion { get; set; }

    private bool isAdding = false;

    private async Task AddToCart()
    {
        if (isAdding) return;
        
        isAdding = true;
        try
        {
            var imageUrl = string.IsNullOrEmpty(ImageUrl) ? "/assets/images/products/product.jpg" : ImageUrl;
            // Lấy thông tin inventory nếu có (có thể null nếu không có)
            int? availableQuantity = null;
            try
            {
                var product = await ProductService.GetProductById(ProductId);
                availableQuantity = product?.Inventory?.Quantity;
            }
            catch
            {
                // Ignore nếu không lấy được inventory
            }
            await CartService.AddToCart(ProductId, ProductName, imageUrl, Price, 1, availableQuantity);
            // Có thể thêm thông báo thành công ở đây nếu cần
        }
        finally
        {
            isAdding = false;
        }
    }
}

