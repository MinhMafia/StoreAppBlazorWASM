@* Component hiển thị thẻ sản phẩm trong danh sách *@
@using Blazored.LocalStorage
@inject IStoreCartService CartService
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JS

<div class="product-card">
    <div class="product-image">
        <img src="@ImageUrl" alt="@ProductName" />
        @if (HasPromotion)
        {
            <span class="promotion-badge">KHUYẾN MÃI</span>
        }
    </div>
    <div class="product-info">
        <h3 class="product-name">@ProductName</h3>
        <div class="product-price">
            @if (OriginalPrice.HasValue && OriginalPrice.Value > Price)
            {
                <span class="original-price">@OriginalPrice.Value.ToString("N0") đ</span>
            }
            <span class="current-price">@Price.ToString("N0") đ</span>
        </div>
        <button class="btn btn-primary btn-add-to-cart" @onclick="AddToCart" disabled="@isAdding">
            @if (isAdding)
            {
                <text>Đang thêm...</text>
            }
            else
            {
                <text>Thêm vào giỏ</text>
            }
        </button>
    </div>
</div>

@code {
    [Parameter] public int ProductId { get; set; }
    [Parameter] public string ProductName { get; set; } = "";
    [Parameter] public string ImageUrl { get; set; } = "";
    [Parameter] public decimal Price { get; set; }
    [Parameter] public decimal? OriginalPrice { get; set; }
    [Parameter] public bool HasPromotion { get; set; }

    private bool isAdding = false;

    private async Task AddToCart()
    {
        if (isAdding) return;

        // Kiểm tra đăng nhập trước khi cho thêm vào giỏ
        var token = await LocalStorage.GetItemAsStringAsync("authToken");
        if (string.IsNullOrWhiteSpace(token))
        {
            await JS.InvokeVoidAsync("alert", "Vui lòng đăng nhập để mua hàng.");
            var returnUrl = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/login?returnUrl={returnUrl}");
            return;
        }
        
        isAdding = true;
        try
        {
            var imageUrl = string.IsNullOrEmpty(ImageUrl) ? "/assets/images/products/product.jpg" : ImageUrl;
            await CartService.AddToCart(ProductId, ProductName, imageUrl, Price, 1);
        }
        finally
        {
            isAdding = false;
        }
    }
}

