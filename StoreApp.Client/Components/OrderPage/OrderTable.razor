<div class="bg-white rounded-xl shadow-xl overflow-hidden">

    @* {/* Header */} *@
    <div class="p-6 border-b bg-gradient-to-r from-gray-100 to-gray-200">
        <h3 class="text-2xl font-bold text-gray-800">DANH SÁCH ĐƠN HÀNG</h3>
    </div>

    @* {/* Table */} *@
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                <tr>
                    <th class="px-6 py-4 text-left font-bold">Mã đơn</th>
                    <th class="px-6 py-4 text-center font-bold">Ngày mua hàng</th>
                    <th class="px-6 py-4 text-left font-bold">Khách</th>
                    <th class="px-6 py-4 text-left font-bold">NV</th>
                    <th class="px-6 py-4 text-right font-bold">Tiền</th>
                    <th class="px-6 py-4 text-center font-bold">Trạng thái đơn hàng</th>
                    <th class="px-6 py-4 text-center font-bold">Khuyến mãi</th>
                    <th class="px-6 py-4 text-center font-bold">Phương thức TT</th>
                    <th class="px-6 py-4 text-center font-bold">Trạng thái TT</th>
                    <th class="px-6 py-4 text-center font-bold">Thao tác</th>
                </tr>
            </thead>

            <tbody class="divide-y">
                                @if (listOrders == null || listOrders.Count == 0)
                {
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                            Không có đơn hàng nào để hiển thị.
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var order in listOrders)
                    {
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 font-medium">@order.OrderNumber</td>

                            <td class="px-6 py-4 text-center">
                                <span class="px-2 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                    @order.CreatedAt.ToString("dd/MM/yyyy")
                                </span>
                            </td>

                            <td class="px-6 py-4">@order.CustomerName</td>
                            <td class="px-6 py-4">@order.UserName</td>

                            <td class="px-6 py-4 text-right font-bold text-green-700">
                                @order.TotalAmount.ToString("N0")₫
                            </td>

                            <td class="px-6 py-4 text-center">
                                <span class="px-3 py-1 text-sm font-bold rounded-full @(GetStatusColor(order.Status))">
                                    @order.Status
                                </span>
                            </td>

                            <td class="px-6 py-4 text-center">
                                @if (order.PromotionCode != null)
                                {
                                    <span class="px-2 py-1 text-sm font-bold rounded-full bg-green-100 text-green-800">
                                        @order.PromotionCode
                                    </span>
                                }
                                else
                                {
                                    <span class="px-2 py-1 text-sm font-bold rounded-full bg-gray-100 text-gray-800">
                                        N/A
                                    </span>
                                }
                            </td>
                            <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 text-sm font-bold rounded-full @(GetPaymentMethodColor(order.PaymentMethod))">
                                @GetPaymentMethodText(order.PaymentMethod)
                            </span>

                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="px-3 py-1 text-sm font-bold rounded-full @(GetPaymentStatusColor(order.PaymentStatus))">
                                    @GetPaymentStatusText(order.PaymentStatus)
                                </span>
                            </td>


                            <td class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button 
                                        class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700"
                                        @onclick="() => ViewOrderDetail.InvokeAsync(order)">
                                        Xem
                                    </button>
                                    @* Nút Xử lý chỉ cho order online *@
                                    @if (order.Status == "pending" && (
                                        (order.PaymentMethod?.ToLower() == "cash" && order.PaymentStatus == "pending") ||
                                        (order.PaymentMethod?.ToLower() != "cash" && order.PaymentStatus == "paid")
                                        ))
                                    {
                                        <button class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700">
                                            Xử lý
                                        </button>
                                    }

                                    @* Nút Hủy chỉ khi order online, cash, pending *@
                                    
                                    @if (order.Status == "pending" && order.PaymentStatus == "pending" && order.PaymentMethod?.ToLower() == "cash")
                                    {
                                        <button class="px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs font-bold hover:bg-red-700">
                                            Hủy
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }

                
            </tbody>
        </table>
    </div>

    
    @* Pagination *@
    <div class="flex items-center justify-between p-5 border-t bg-gray-50">

        @* Nút Trước *@
        @if (currentPage > 1)
        {
            <button class="px-6 py-3 rounded-lg font-bold bg-purple-500 text-white hover:bg-purple-600"
                    @onclick="() => ChangePage(currentPage - 1)">
                Trước
            </button>
        }
        else
        {
            <div></div> @* Giữ khoảng trống cho layout nếu muốn *@
        }

        <span class="text-sm font-bold">
            Trang <strong>@currentPage</strong> / <strong>@totalPages</strong>
        </span>

        @* Nút Sau *@
        @if (currentPage < totalPages)
        {
            <button class="px-6 py-3 rounded-lg font-bold bg-purple-500 text-white hover:bg-purple-600"
                    @onclick="() => ChangePage(currentPage + 1)">
                Sau
            </button>
        }
        else
        {
            <div></div> @* Giữ khoảng trống cho layout nếu muốn *@
        }

    </div>



</div>
@code {
    [Parameter]
    public List<OrderDTO> listOrders { get; set; }

    [Parameter]
    public int currentPage { get; set; }

    [Parameter]
    public int totalPages { get; set; }

    [Parameter]
    public EventCallback<int> onPageChange { get; set; }
    
    [Parameter] 
    public EventCallback<OrderDTO> ViewOrderDetail { get; set; }


    private async Task ChangePage(int page)
    {
        if (onPageChange.HasDelegate)
        {
            await onPageChange.InvokeAsync(page);
        }
    }

    //  Trạng thái đơn hàng
    string GetStatusColor(string status)
    {
        // Trả về class màu theo trạng thái
        return status.ToLower() switch
        {
            "pending" => "bg-yellow-100 text-yellow-800",
            "paid" => "bg-blue-100 text-blue-800",
            "completed" => "bg-green-100 text-green-800",
            "cancelled" => "bg-red-100 text-red-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }
    string GetPaymentMethodText(string method)
    {
        return method?.ToLower() switch
        {
            "cash" => "Tiền mặt",
            "card" => "Thẻ",
            "ecard" => "Thẻ điện tử",
            "other" => "MOMO",
            _ => "-"
        };
    }

    string GetPaymentMethodColor(string method)
    {
        return method?.ToLower() switch
        {
            "cash" => "bg-yellow-100 text-yellow-800",
            "card" => "bg-blue-100 text-blue-800",
            "other" => "bg-pink-100 text-pink-800",
            "ecard" => "bg-gray-50 text-gray-700",
            _ => "bg-gray-50 text-gray-700"
        };
    }


    string GetPaymentStatusText(string paymentStatus)
    {
        return paymentStatus?.ToLower() switch
        {
            "pending" => "Chưa thanh toán",
            "paid" => "Đã thanh toán",
            "completed" => "Hoàn tất thanh toán",
            "failed" => "Thanh toán thất bại",
            _ => paymentStatus ?? "-"
        };
    }

    // Trạng thái thanh toán
    string GetPaymentStatusColor(string paymentStatus)
    {
        return paymentStatus?.ToLower() switch
        {
            "pending" => "bg-yellow-100 text-yellow-800",
            "paid" => "bg-green-100 text-green-800",
            "failed" => "bg-red-100 text-red-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

}