@inject IJSRuntime JS
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl mb-6 border border-indigo-200 shadow-sm">

    <h4 class="text-xl font-bold text-gray-800 mb-4">CHI TI·∫æT ƒê∆†N H√ÄNG</h4>

    @if(ordersFormMode == "create")
    {
        <div class="space-y-5 mb-6">

            <!-- Ch·ªçn s·∫£n ph·∫©m -->
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">S·∫£n ph·∫©m</label>
                <div class="flex gap-3">
                    <input readonly placeholder="Ch∆∞a ch·ªçn s·∫£n ph·∫©m..." value="@selectedProduct?.ProductName"
                        class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-100 text-sm font-medium" />

                    <button 
                        @onclick="openProductModal"
                    type="button" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Ch·ªçn
                    </button>
                </div>
            </div>

            <!-- Grid th√¥ng tin -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Gi√°</label>
                    <input type="number" placeholder="0" value="@selectedProduct?.Price" readonly
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">S·ªë l∆∞·ª£ng t·ªìn kho</label>
                    <input type="number"  placeholder="1"  value="@(selectedProduct?.Inventory?.Quantity ?? 0)" min="1" readonly
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>


                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">S·ªë l∆∞·ª£ng mu·ªën mua</label>
                    <input type="number" value="@quantityToBuy" min="1" 
                        @onchange="OnQuantityChanged" class="w-full px-4 py-2.5 border rounded-lg" />
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">T·ªïng ti·ªÅn</label>
                    <input readonly value="@totalAmount.ToString("C")"
                        class="w-full px-4 py-2.5 border bg-gray-100 rounded-lg" />
                </div>
            </div>

            <!-- Hai n√∫t ngang h√†ng -->
            <div class="flex gap-4">
                @if(OnEditOrderItemMode == "add"){
                    <button
                        @onclick="AddOrUpdateOrderItem"
                        type="button" class="px-7 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-md flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Th√™m chi ti·∫øt
                    </button>

                }

                @if (selectedOrderItem != null)
                {
                    <button
                        @onclick="SaveEditedOrderItem"
                        type="button"
                        class="px-7 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition shadow-md flex items-center gap-2">

                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        L∆∞u ch·ªânh s·ª≠a
                    </button>

                    <button
                        @onclick="ExitEditMode"
                        type="button"
                        class="px-7 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition shadow-md flex items-center gap-2">

                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Tho√°t
                    </button>
                }


            </div>
        </div>
       
    }
    
    <!-- FORM -->
    

    <!-- DANH S√ÅCH S·∫¢N PH·∫®M -->
    <div>
        <h4 class="text-xl font-bold text-gray-800 mb-4">DANH S√ÅCH S·∫¢N PH·∫®M</h4>

        <div class="overflow-x-auto rounded-xl border border-gray-300 shadow">
            <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700">
                    <tr>
                        <th class="px-6 py-4 text-left font-bold">M√£ SP</th>
                        <th class="px-6 py-4 text-left font-bold">T√™n SP</th>
                        <th class="px-6 py-4 text-center font-bold">S·ªë l∆∞·ª£ng mu·ªën mua</th>
                        @if (ordersFormMode == "create"){
                            <th class="px-6 py-4 text-center font-bold">S·ªë l∆∞·ª£ng t·ªìn kho</th>
                        }
                        <th class="px-6 py-4 text-right font-bold">Gi√°</th>
                        <th class="px-6 py-4 text-right font-bold">T·ªïng</th>
                        @if (ordersFormMode == "create")
                        {
                            <th class="px-6 py-4 text-center font-bold">Thao t√°c</th>
                        }
                        
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-200 bg-white">
                    @if(ListOrderProducts.Count == 0){
                        <tr>
                            <td colspan="@((ordersFormMode == "create") ? 7 : 5)" class="px-6 py-4 text-center text-gray-500">
                                Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o .
                            </td>
                        </tr>
                    }else{
                        @foreach(var item in ListOrderProducts)
                        {
                            <tr class="hover:bg-indigo-50 transition duration-200">
                                <td class="px-6 py-4 font-medium">@item.id</td>
                                <td class="px-6 py-4">@item.product</td>
                                <td class="px-6 py-4 text-center">@item.qty</td>
                                @if(ordersFormMode == "create"){
                                    <td class="px-6 py-4 text-center">@item.inventoryQuantity </td>
                                }
                                <td class="px-6 py-4 text-right">@item.price.ToString("N0")</td>
                                <td class="px-6 py-4 text-right font-bold text-blue-600">@item.total.ToString("N0")</td>
                                @if (ordersFormMode == "create")
                                {
                                    <td class="px-6 py-4 text-center">
                                        <div class="flex justify-center gap-3">
                                            <button 
                                                    @onclick="() => OnEditOrderItem(item)"
                                                    type="button"
                                                    class="flex items-center gap-1.5 px-4 py-2 bg-blue-500 text-white text-xs font-semibold rounded-lg hover:bg-amber-600 transition shadow">
                                                S·ª≠a
                                            </button>
                                            <button 
                                                    @onclick="() => RemoveOrderItem(item)"
                                                    type="button"
                                                    class="flex items-center gap-1.5 px-4 py-2 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition shadow">
                                                X√≥a
                                            </button>
                                        </div>
                                    </td>
                                }

                            </tr>
                        }

                    }
                   

                </tbody>
            </table>
        </div>
        @if (showProductModal)
        {
            <ProductModel 
            closeModal="closeProductModal"
            OnProductSelected="OnProductChosen"
            />
        }

        
    </div>
</div>

@code {
    [Parameter]
    public string ordersFormMode { get; set; } = "create"; // "create" ho·∫∑c "edit"


    string OnEditOrderItemMode = "add";

    [Parameter] 
    public List<OrderItemReponse> ListOrderProducts { get; set; } = new List<OrderItemReponse>();
    
    [Parameter]
    public OrderDTO currentOrder { get; set; } = null!;
    [Parameter]
    public ProductDTO? selectedProduct { get; set; }
    [Parameter] public EventCallback<OrderDTO> OnOrderChanged { get; set; }

    // N·∫øu nh·∫•n th√™m chi ti·∫øt th√¨ s·∫Ω ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ ch·ªçn ch∆∞a, ki·ªÉm tra s·ªë l∆∞·ª£ng mua c√≥ h·ª£p l·ªá r·ªìi selectedOrderItem g√°n gi√° tr·ªã

    bool showProductModal = false;
    void openProductModal()
    {
        showProductModal = true;
    }

    void closeProductModal()
    {
        showProductModal = false;
    }

    async Task OnProductChosen(ProductDTO product)
    {
        selectedProduct = product;
        showProductModal = false; // ƒë√≥ng modal sau khi ch·ªçn
        await InvokeAsync(StateHasChanged);
    }
    // S·ªë l∆∞·ª£ng mu·ªën mua hi·ªán t·∫°i c·ªßa s·∫£n ph·∫©m ƒëang ch·ªçn
    int quantityToBuy = 1;

    // T·ªïng ti·ªÅn = gi√° s·∫£n ph·∫©m * s·ªë l∆∞·ª£ng mua
    decimal totalAmount => selectedProduct != null ? selectedProduct.Price * quantityToBuy : 0;
    // Khi ng∆∞·ªùi d√πng thay ƒë·ªïi s·ªë l∆∞·ª£ng mu·ªën mua
    void OnQuantityChanged(ChangeEventArgs e)
    {
        if(selectedProduct == null) return;

        if(int.TryParse(e.Value?.ToString(), out int newQty))
        {
            if(newQty <= 0)
            {
                // Kh√¥ng cho s·ªë l∆∞·ª£ng <= 0
                quantityToBuy = 1;
            }
            else if(newQty > selectedProduct.Inventory.Quantity)
            {
                // Kh√¥ng cho mua qu√° t·ªìn kho
                quantityToBuy = selectedProduct.Inventory.Quantity;
                _ = ShowAlert($"Kh√¥ng ƒë∆∞·ª£c mua qu√° t·ªìn kho ({selectedProduct.Inventory.Quantity})");
            }
            else
            {
                quantityToBuy = newQty;
            }
        }
        StateHasChanged();
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o popup
    async Task ShowAlert(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }

    // Th√™m chi ti·∫øt s·∫£n ph·∫©m v√†o danh s√°ch
    void AddOrUpdateOrderItem()
    {
        if (OnEditOrderItemMode == "edit")
            return; // Kh√¥ng cho th√™m khi ƒëang edit

        if(selectedProduct == null) 
            return;

        // Ki·ªÉm tra xem s·∫£n ph·∫©m ƒë√£ c√≥ trong danh s√°ch ch∆∞a
        var existing = ListOrderProducts.FirstOrDefault(x => x.id == selectedProduct.Id);
        if(existing != null)
        {
            // N·∫øu ƒë√£ c√≥, c·ªông d·ªìn s·ªë l∆∞·ª£ng mua c≈© + m·ªõi
            int newQty = existing.qty + quantityToBuy;

            if(newQty > selectedProduct.Inventory.Quantity)
            {
                // N·∫øu v∆∞·ª£t t·ªìn kho, b√°o l·ªói
                _ = ShowAlert($"Kh√¥ng ƒë∆∞·ª£c mua qu√° t·ªìn kho ({selectedProduct.Inventory.Quantity})");
                return;
            }

            existing.qty = newQty;
            existing.total = existing.qty * existing.price;
        }
        else
        {
            // N·∫øu ch∆∞a c√≥, th√™m s·∫£n ph·∫©m m·ªõi v√†o danh s√°ch
            ListOrderProducts.Add(new OrderItemReponse
            {
                id = selectedProduct.Id,
                product = selectedProduct.ProductName,
                price = selectedProduct.Price,
                qty = quantityToBuy,
                total = selectedProduct.Price * quantityToBuy,
                inventoryQuantity = selectedProduct.Inventory.Quantity
            });
        }

        // üî• C·∫≠p nh·∫≠t ti·ªÅn ƒë∆°n h√†ng
        UpdateOrderSummary();


        // Reset l·∫°i form ch·ªçn s·∫£n ph·∫©m
        selectedProduct = null;
        quantityToBuy = 1;
        StateHasChanged();
    }


    // X√≥a s·∫£n ph·∫©m kh·ªèi danh s√°ch
    void RemoveOrderItem(OrderItemReponse item)
    {
        ListOrderProducts.Remove(item);
        UpdateOrderSummary();
        StateHasChanged();
    }



    // Khi ng∆∞·ªùi d√πng nh·∫•n n√∫t "S·ª≠a" trong danh s√°ch s·∫£n ph·∫©m
    OrderItemReponse? selectedOrderItem = null;

    // Ch·ªçn l·∫°i selecteProduct ƒë·ªÉ hi·ªán l√™n form th√¥i
    void OnEditOrderItem(OrderItemReponse item)
    {
        OnEditOrderItemMode = "edit";
        selectedOrderItem = item;
        selectedProduct = new ProductDTO
        {
            Id = item.id,
            ProductName = item.product,
            Price = item.price,
            Inventory = new InventoryDTO
            {
                Quantity = item.inventoryQuantity  // T·ªìn kho th·∫≠t trong kho
            }
        };

        quantityToBuy = item.qty;
    }

    void ExitEditMode(){
        selectedOrderItem=null;
        selectedProduct=null;
        quantityToBuy = 1;
        OnEditOrderItemMode = "add";
    }


    // Khi nh·∫•n L∆∞u ch·ªânh s·ª≠a
    void SaveEditedOrderItem()
    {
        if (selectedProduct == null || selectedOrderItem == null)
            return;

        // Ki·ªÉm tra t·ªìn kho khi ch·ªânh s·ª≠a
        if (quantityToBuy > selectedProduct.Inventory.Quantity)
        {
            _ = ShowAlert($"Kh√¥ng ƒë∆∞·ª£c mua qu√° t·ªìn kho ({selectedProduct.Inventory.Quantity})");
            return;
        }

        // C·∫≠p nh·∫≠t tr·ª±c ti·∫øp ƒë·ªëi t∆∞·ª£ng ƒëang ch·ªânh s·ª≠a
        selectedOrderItem.product = selectedProduct.ProductName;
        selectedOrderItem.price = selectedProduct.Price;
        selectedOrderItem.qty = quantityToBuy;
        selectedOrderItem.total = selectedProduct.Price * quantityToBuy;
        selectedOrderItem.inventoryQuantity = selectedProduct.Inventory.Quantity;
          // üî• C·∫≠p nh·∫≠t ti·ªÅn ƒë∆°n h√†ng
        UpdateOrderSummary();


        ExitEditMode();
        StateHasChanged();
    }
    void UpdateOrderSummary()
    {
        if (currentOrder == null) return;

        // 1. T√≠nh subtotal
        currentOrder.Subtotal = ListOrderProducts.Sum(x => x.total);

        // 3. T·ªïng thanh to√°n
        currentOrder.TotalAmount = currentOrder.Subtotal - currentOrder.Discount;
        // üëâ G·ªçi callback b√°o cho parent bi·∫øt d·ªØ li·ªáu ƒë√£ ƒë·ªïi
        OnOrderChanged.InvokeAsync(currentOrder);
    }









    
}