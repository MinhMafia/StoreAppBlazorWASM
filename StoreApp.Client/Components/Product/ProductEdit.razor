@* Components/Product/ProductEdit.razor *@
@using StoreApp.Shared
@inject IJSRuntime JS

<!-- Modal Overlay -->
<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @onclick="HandleBackdropClick">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden" @onclick:stopPropagation>
        
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h2 class="text-xl font-bold text-gray-900">Chỉnh sửa sản phẩm</h2>
        </div>

        <!-- Body -->
        <div class="overflow-y-auto" style="max-height: calc(90vh - 140px);">
            <EditForm Model="@editProduct" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <div class="p-6">
                    <div class="grid grid-cols-12 gap-6">
                        
                        <!-- Left: Image -->
                        <div class="col-span-12 md:col-span-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hình ảnh sản phẩm</label>
                            
                            <!-- Image Preview -->
                            <div class="aspect-square rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 flex items-center justify-center overflow-hidden relative group">
                                @if (string.IsNullOrEmpty(previewImageUrl))
                                {
                                    <div class="text-center text-gray-400">
                                        <i class="bi bi-image text-6xl mb-2"></i>
                                        <p class="text-sm">Chưa có ảnh</p>
                                    </div>
                                }
                                else
                                {
                                    <img src="@previewImageUrl" alt="Preview" class="w-full h-full object-cover" />
                                    
                                    <!-- Delete Image Button (Overlay) -->
                                    <button type="button"
                                            @onclick="ClearImage"
                                            class="absolute top-2 right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">
                                        <i class="bi bi-x-lg text-sm"></i>
                                    </button>
                                }
                            </div>

                            <!-- Upload Options -->
                            <div class="mt-3 space-y-2">
                                <!-- Chọn file từ máy -->
                                <div>
                                    <InputFile OnChange="HandleImageSelected" 
                                               accept="image/*" 
                                               class="hidden" 
                                               id="imageUploadEdit"
                                               disabled="@hasUrlInput" />
                                    <label for="imageUploadEdit" 
                                           class="@(hasUrlInput ? "opacity-50 cursor-not-allowed" : "cursor-pointer hover:bg-gray-50") w-full px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 flex items-center justify-center gap-2">
                                        <i class="bi bi-upload"></i>
                                        Chọn ảnh từ máy
                                    </label>
                                </div>

                                <!-- Divider -->
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 border-t border-gray-300"></div>
                                    <span class="text-xs text-gray-500 font-medium">HOẶC</span>
                                    <div class="flex-1 border-t border-gray-300"></div>
                                </div>

                                <!-- URL Input -->
                                <div class="relative">
                                    <input type="text"
                                           @bind="urlInput"
                                           @bind:event="oninput"
                                           @bind:after="HandleUrlInput"
                                           disabled="@hasFileInput"
                                           class="@(hasFileInput ? "opacity-50 cursor-not-allowed" : "") w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="Nhập URL ảnh..." />
                                    @if (!string.IsNullOrEmpty(urlInput))
                                    {
                                        <button type="button"
                                                @onclick="ClearUrl"
                                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                            <i class="bi bi-x-circle-fill"></i>
                                        </button>
                                    }
                                </div>
                            </div>

                            <!-- Helper Text -->
                            <p class="mt-2 text-xs text-gray-500">
                                @if (hasFileInput)
                                {
                                    <span>✓ Ảnh từ máy đã chọn. Xóa ảnh để nhập URL.</span>
                                }
                                else if (hasUrlInput)
                                {
                                    <span>✓ URL đã nhập. Xóa để chọn ảnh từ máy.</span>
                                }
                                else
                                {
                                    <span>Chọn ảnh từ máy hoặc nhập URL ảnh</span>
                                }
                            </p>

                            <!-- Error Message -->
                            @if (!string.IsNullOrEmpty(uploadError))
                            {
                                <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
                                    <i class="bi bi-exclamation-triangle-fill text-red-500 text-sm mt-0.5"></i>
                                    <p class="text-xs text-red-600">@uploadError</p>
                                </div>
                            }
                        </div>

                        <!-- Right: Form Fields -->
                        <div class="col-span-12 md:col-span-8">
                            <div class="space-y-4">
                                
                                <!-- Row 1: Tên & SKU -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Tên sản phẩm <span class="text-red-500">*</span>
                                        </label>
                                        <InputText @bind-Value="editProduct.ProductName" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                   placeholder="Nhập tên sản phẩm" />
                                        <ValidationMessage For="@(() => editProduct.ProductName)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            SKU <span class="text-red-500">*</span>
                                        </label>
                                        <InputText @bind-Value="editProduct.Sku" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-100 cursor-not-allowed"
                                                   disabled />
                                        <p class="text-xs text-gray-500 mt-1">SKU không thể thay đổi</p>
                                    </div>
                                </div>

                                <!-- Row 2: Giá & Đơn vị -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Giá bán <span class="text-red-500">*</span>
                                        </label>
                                        <InputNumber @bind-Value="editProduct.Price" 
                                                     @bind-Value:after="ValidatePriceChange"
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                     placeholder="0" />
                                        <ValidationMessage For="@(() => editProduct.Price)" class="text-red-500 text-xs mt-1 block" />
                                        @if (!string.IsNullOrEmpty(priceValidationMessage))
                                        {
                                            <p class="text-red-600 text-xs mt-1 font-medium">@priceValidationMessage</p>
                                        }
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Đơn vị <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.UnitId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="0">-- Chọn đơn vị --</option>
                                            @foreach (var unit in Units ?? Enumerable.Empty<UnitDTO>())
                                            {
                                                <option value="@unit.Id">@unit.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.UnitId)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                </div>

                                <!-- Row 3: Nhà cung cấp & Danh mục -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Nhà cung cấp <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.SupplierId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="0">-- Chọn nhà cung cấp --</option>
                                            @foreach (var sup in Suppliers ?? Enumerable.Empty<SupplierDTO>())
                                            {
                                                <option value="@sup.Id">@sup.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.SupplierId)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Danh mục <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.CategoryId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="0">-- Chọn danh mục --</option>
                                            @foreach (var cat in Categories ?? Enumerable.Empty<CategoryDTO>())
                                            {
                                                <option value="@cat.Id">@cat.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.CategoryId)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                </div>

                                <!-- Row 4: Mô tả -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả</label>
                                    <InputTextArea @bind-Value="editProduct.Description" 
                                                   rows="4"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 resize-none"
                                                   placeholder="Mô tả chi tiết về sản phẩm" />
                                    <ValidationMessage For="@(() => editProduct.Description)" class="text-red-500 text-xs mt-1 block" />
                                </div>

                                <!-- Row 5: Trạng thái & Buttons -->
                                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                                    <label class="inline-flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" 
                                            checked="@editProduct.IsActive"
                                            @onchange="HandleIsActiveChange"
                                            class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                        <span class="text-sm font-medium text-gray-700">Hiển thị sản phẩm</span>
                                    </label>
                                    <div class="flex items-center gap-3">
                                        <button type="button" 
                                                @onclick="HandleCancel"
                                                disabled="@Saving"
                                                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 text-sm font-medium disabled:opacity-50">
                                            Hủy
                                        </button>
                                        <button type="submit" 
                                                disabled="@Saving"
                                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium disabled:opacity-50 flex items-center gap-2">
                                            @if (Saving)
                                            {
                                                <span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                                                <span>Đang lưu...</span>
                                            }
                                            else
                                            {
                                                <span>Cập nhật</span>
                                            }
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>

            </EditForm>
        </div>

    </div>
</div>

@code {
    [Parameter] public ProductDTO? Product { get; set; }
    [Parameter] public List<CategoryDTO>? Categories { get; set; }
    [Parameter] public List<SupplierDTO>? Suppliers { get; set; }
    [Parameter] public List<UnitDTO>? Units { get; set; }
    [Parameter] public bool Saving { get; set; }
    [Parameter] public EventCallback<ProductDTO> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<(int, bool)> OnDelete { get; set; }

    private ProductDTO editProduct = new();
    private string? previewImageUrl = null;
    private IBrowserFile? selectedImageFile = null;
    private string? urlInput = null;
    private string? uploadError = null;
    private string? originalImageUrl = null; // Lưu URL ảnh gốc
    private string? priceValidationMessage = null; // Thông báo validation giá bán

    // Flags để kiểm soát UI
    private bool hasFileInput => selectedImageFile != null;
    private bool hasUrlInput => !string.IsNullOrWhiteSpace(urlInput);

    // Public property để ProductList lấy file
    public IBrowserFile? SelectedImageFile => selectedImageFile;

    protected override void OnParametersSet()
    {
        if (Product != null)
        {
            editProduct = new ProductDTO
            {
                Id = Product.Id,
                ProductName = Product.ProductName,
                Sku = Product.Sku,
                Description = Product.Description,
                CategoryId = Product.CategoryId,
                SupplierId = Product.SupplierId,
                UnitId = Product.UnitId,
                Cost = Product.Cost,
                Price = Product.Price,
                ImageUrl = Product.ImageUrl,
                IsActive = Product.IsActive
            };

            // Khởi tạo preview từ ảnh hiện tại
            originalImageUrl = Product.ImageUrl;
            previewImageUrl = Product.ImageUrl;
            
            // Reset validation khi mở modal
            priceValidationMessage = null;
        }
    }

    private void ValidatePriceChange()
    {
        priceValidationMessage = null;
        
        // Chỉ validate khi sản phẩm đang active
        if (editProduct.IsActive && editProduct.Cost.HasValue && editProduct.Cost.Value > 0)
        {
            var minimumPrice = editProduct.Cost.Value * 1.10m;
            if (editProduct.Price < minimumPrice)
            {
                priceValidationMessage = $"Giá bán tối thiểu là {minimumPrice:N0}₫ (giá vốn + 10%)";
            }
        }
    }

    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        uploadError = null;
        selectedImageFile = null;
        previewImageUrl = null;

        try
        {
            var file = e.File;

            if (file.Size > 5 * 1024 * 1024)
            {
                uploadError = "Kích thước file không được vượt quá 5MB";
                return;
            }

            var allowedTypes = new[] { "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp" };
            if (!allowedTypes.Contains(file.ContentType.ToLower()))
            {
                uploadError = "Chỉ chấp nhận file ảnh (JPEG, PNG, GIF, WebP)";
                return;
            }

            selectedImageFile = file;

            // Generate preview
            var buffer = new byte[file.Size];
            await file.OpenReadStream(5 * 1024 * 1024).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            previewImageUrl = $"data:{file.ContentType};base64,{base64}";
        }
        catch (Exception ex)
        {
            uploadError = $"Lỗi: {ex.Message}";
        }
    }

    private void HandleUrlInput()
    {
        uploadError = null;
        
        if (string.IsNullOrWhiteSpace(urlInput))
        {
            // Nếu xóa URL, quay về ảnh gốc
            previewImageUrl = originalImageUrl;
            return;
        }

        // Validate URL format
        if (!Uri.TryCreate(urlInput, UriKind.Absolute, out var uri) && 
            !urlInput.StartsWith("/"))
        {
            uploadError = "URL không hợp lệ";
            previewImageUrl = originalImageUrl;
            return;
        }

        // Set preview to URL
        previewImageUrl = urlInput;
    }

    private void ClearImage()
    {
        selectedImageFile = null;
        previewImageUrl = originalImageUrl; // Quay về ảnh gốc
        uploadError = null;
    }

    private void ClearUrl()
    {
        urlInput = null;
        previewImageUrl = originalImageUrl; // Quay về ảnh gốc
        uploadError = null;
    }

    private async Task HandleSubmit()
    {
        priceValidationMessage = null;
        
        // Validate giá bán nếu sản phẩm đang active
        if (editProduct.IsActive)
        {
            // Kiểm tra có giá vốn không
            if (!editProduct.Cost.HasValue || editProduct.Cost.Value <= 0)
            {
                priceValidationMessage = "❌ Không thể lưu: Sản phẩm đang bật nhưng chưa có giá vốn. Vui lòng nhập giá vốn hoặc tắt trạng thái sản phẩm.";
                await JS.InvokeVoidAsync("alert", "Không thể lưu sản phẩm!\n\nSản phẩm đang ở trạng thái BẬT nhưng chưa có giá vốn.\n\nVui lòng nhập giá vốn hoặc tắt trạng thái sản phẩm.");
                return;
            }
            
            // Kiểm tra giá bán phải > giá vốn + 10%
            var minimumPrice = editProduct.Cost.Value * 1.10m;
            if (editProduct.Price < minimumPrice)
            {
                priceValidationMessage = $"❌ Không thể lưu: Giá bán phải ≥ {minimumPrice:N0}₫ (giá vốn {editProduct.Cost.Value:N0}₫ + 10%). Hiện tại: {editProduct.Price:N0}₫";
                await JS.InvokeVoidAsync("alert", 
                    @* $"Không thể lưu sản phẩm!\n\n" +
                    $"Giá bán không hợp lệ:\n" +
                    $"• Giá vốn hiện tại: {editProduct.Cost.Value:N0}₫\n" +
                    $"• Giá bán hiện tại: {editProduct.Price:N0}₫\n" +
                    $"• Giá bán tối thiểu: {minimumPrice:N0}₫\n\n" +
                    $"Giá bán phải lớn hơn giá vốn ít nhất 10%.\n\n" + *@
                    $"Vui lòng tăng giá bán lên ít nhất {minimumPrice:N0}₫.");
                return;
            }
        }

        // Nếu có file từ máy
        if (selectedImageFile != null)
        {
            editProduct.ImageUrl = "PENDING_UPLOAD";
        }
        // Nếu có URL mới
        else if (!string.IsNullOrWhiteSpace(urlInput))
        {
            editProduct.ImageUrl = urlInput.Trim();
        }
        // Giữ nguyên ảnh cũ (không thay đổi)
        else
        {
            editProduct.ImageUrl = originalImageUrl;
        }
        
        await OnSave.InvokeAsync(editProduct);
    }

    private void HandleCancel()
    {
        if (!Saving)
        {
            OnCancel.InvokeAsync();
        }
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync((editProduct.Id, editProduct.IsActive));
    }

    private void HandleBackdropClick()
    {
        if (!Saving)
        {
            OnCancel.InvokeAsync();
        }
    }

    private async Task HandleIsActiveChange(ChangeEventArgs e)
    {
        var newValue = (bool)e.Value!;
        
        // Nếu đang cố BẬT sản phẩm
        if (newValue && !editProduct.IsActive)
        {
            // Kiểm tra có giá vốn không
            if (!editProduct.Cost.HasValue || editProduct.Cost.Value <= 0)
            {
                await JS.InvokeVoidAsync("alert", "Vui lòng nhập giá vốn trước khi bật trạng thái sản phẩm.");
                return; // Không cho thay đổi
            }
            
            // Kiểm tra giá bán phải > giá vốn + 10%
            var minimumPrice = editProduct.Cost.Value * 1.10m;
            if (editProduct.Price < minimumPrice)
            {
                await JS.InvokeVoidAsync("alert", $"Giá bán tối thiểu là {minimumPrice:N0}₫. Vui lòng điều chỉnh giá bán.");
                return; // Không cho thay đổi
            }
        }
        
        // Nếu pass tất cả validation, cho phép thay đổi
        editProduct.IsActive = newValue;
    }
}