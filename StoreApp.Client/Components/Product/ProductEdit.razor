@* Components/Product/ProductEdit.razor *@
@using StoreApp.Shared
@inject IJSRuntime JS

<!-- Modal Overlay -->
<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @onclick="HandleBackdropClick">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden" @onclick:stopPropagation>
        
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h2 class="text-xl font-bold text-gray-900">Chỉnh sửa sản phẩm</h2>
        </div>

        <!-- Body -->
        <div class="overflow-y-auto" style="max-height: calc(90vh - 140px);">
            <EditForm Model="@editProduct" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <div class="p-6">
                    <div class="grid grid-cols-12 gap-6">
                        
                        <!-- Left: Image -->
                        <div class="col-span-12 md:col-span-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hình ảnh sản phẩm</label>
                            <div class="aspect-square rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 flex items-center justify-center overflow-hidden">
                                @if (string.IsNullOrEmpty(editProduct.ImageUrl))
                                {
                                    <div class="text-center text-gray-400">
                                        <i class="bi bi-image text-6xl mb-2"></i>
                                        <p class="text-sm">Chưa có ảnh</p>
                                    </div>
                                }
                                else
                                {
                                    <img src="@editProduct.ImageUrl" alt="Preview" class="w-full h-full object-cover" />
                                }
                            </div>
                            <div class="mt-3">
                                <button type="button" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 flex items-center justify-center gap-2">
                                    <i class="bi bi-image"></i>
                                    Chọn ảnh từ máy
                                </button>
                            </div>
                            <div class="mt-2">
                                <InputText @bind-Value="editProduct.ImageUrl" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                           placeholder="Hoặc nhập URL ảnh..." />
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Chọn ảnh từ máy hoặc nhập URL hình ảnh</p>
                        </div>

                        <!-- Right: Form Fields -->
                        <div class="col-span-12 md:col-span-8">
                            <div class="space-y-4">
                                
                                <!-- Row 1: Tên & SKU -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Tên sản phẩm <span class="text-red-500">*</span>
                                        </label>
                                        <InputText @bind-Value="editProduct.ProductName" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500"
                                                   placeholder="" />
                                        <ValidationMessage For="@(() => editProduct.ProductName)" class="text-red-500 text-xs mt-1" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">SKU</label>
                                        <InputText @bind-Value="editProduct.Sku" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-100 cursor-not-allowed"
                                                   placeholder=""
                                                   disabled />
                                    </div>
                                </div>

                                <!-- Row 2: Giá & Đơn vị -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Giá <span class="text-red-500">*</span>
                                        </label>
                                        <InputNumber @bind-Value="editProduct.Price" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500"
                                                     placeholder="0" />
                                        <ValidationMessage For="@(() => editProduct.Price)" class="text-xs text-red-500 mt-1" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Đơn vị <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.UnitId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500">
                                            <option value="">-- Chọn đơn vị --</option>
                                            @foreach (var unit in Units ?? Enumerable.Empty<UnitDTO>())
                                            {
                                                <option value="@unit.Id">@unit.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.UnitId)" class="text-xs text-red-500 mt-1" />
                                    </div>
                                </div>

                                <!-- Row 3: Nhà cung cấp & Danh mục -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Nhà cung cấp <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.SupplierId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500">
                                            <option value="">-- Chọn nhà cung cấp --</option>
                                            @foreach (var sup in Suppliers ?? Enumerable.Empty<SupplierDTO>())
                                            {
                                                <option value="@sup.Id">@sup.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.SupplierId)" class="text-xs text-red-500 mt-1" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Danh mục <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.CategoryId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500">
                                            <option value="">-- Chọn danh mục --</option>
                                            @foreach (var cat in Categories ?? Enumerable.Empty<CategoryDTO>())
                                            {
                                                <option value="@cat.Id">@cat.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.CategoryId)" class="text-xs text-red-500 mt-1" />
                                    </div>
                                </div>

                                <!-- Row 4: Mô tả -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả</label>
                                    <InputTextArea @bind-Value="editProduct.Description" 
                                                   rows="4"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 resize-none"
                                                   placeholder="" />
                                </div>

                                <!-- Row 5: Trạng thái -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái hoạt động</label>
                                    <label class="inline-flex items-center gap-2 cursor-pointer">
                                        <InputCheckbox @bind-Value="editProduct.IsActive" 
                                                       class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                        <span class="text-sm text-gray-700">Đang hoạt động</span>
                                    </label>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
                    <button type="button"
                            @onclick="HandleDelete"
                            class="px-4 py-2 text-red-600 text-sm font-medium hover:text-red-700">
                        @(editProduct.IsActive ? "Vô hiệu hóa" : "Khôi phục")
                    </button>
                    <div class="flex items-center gap-3">
                        <button type="button" 
                                @onclick="HandleCancel"
                                disabled="@Saving"
                                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 text-sm font-medium disabled:opacity-50">
                            Hủy
                        </button>
                        <button type="submit" 
                                disabled="@Saving"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium disabled:opacity-50 flex items-center gap-2">
                            @if (Saving)
                            {
                                <span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                                <span>Đang lưu...</span>
                            }
                            else
                            {
                                <span>Cập nhật</span>
                            }
                        </button>
                    </div>
                </div>

            </EditForm>
        </div>

    </div>
</div>

@code {
    [Parameter] public ProductDTO? Product { get; set; }
    [Parameter] public List<CategoryDTO>? Categories { get; set; }
    [Parameter] public List<SupplierDTO>? Suppliers { get; set; }
    [Parameter] public List<UnitDTO>? Units { get; set; }
    [Parameter] public bool Saving { get; set; }
    [Parameter] public EventCallback<ProductDTO> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<(int, bool)> OnDelete { get; set; }

    private ProductDTO editProduct = new();

    protected override void OnParametersSet()
    {
        if (Product != null)
        {
            editProduct = new ProductDTO
            {
                Id = Product.Id,
                ProductName = Product.ProductName,
                Sku = Product.Sku,
                Description = Product.Description,
                CategoryId = Product.CategoryId,
                SupplierId = Product.SupplierId,
                UnitId = Product.UnitId,
                Cost = Product.Cost,
                Price = Product.Price,
                ImageUrl = Product.ImageUrl,
                IsActive = Product.IsActive
            };
        }
    }

    private async Task HandleSubmit()
    {
        await OnSave.InvokeAsync(editProduct);
    }

    private void HandleCancel()
    {
        if (!Saving)
        {
            OnCancel.InvokeAsync();
        }
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync((editProduct.Id, editProduct.IsActive));
    }

    private void HandleBackdropClick()
    {
        if (!Saving)
        {
            OnCancel.InvokeAsync();
        }
    }
}