@* Components/Product/ProductEdit.razor *@
@using StoreApp.Shared
@inject IJSRuntime JS

<!-- Modal Overlay -->
<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @onclick="HandleBackdropClick">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden" @onclick:stopPropagation>
        
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h2 class="text-xl font-bold text-gray-900">Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h2>
        </div>

        <!-- Body -->
        <div class="overflow-y-auto" style="max-height: calc(90vh - 140px);">
            <EditForm Model="@editProduct" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <div class="p-6">
                    <div class="grid grid-cols-12 gap-6">
                        
                        <!-- Left: Image -->
                        <div class="col-span-12 md:col-span-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
                            
                            <!-- Image Preview -->
                            <div class="aspect-square rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 flex items-center justify-center overflow-hidden relative group">
                                @if (string.IsNullOrEmpty(previewImageUrl))
                                {
                                    <div class="text-center text-gray-400">
                                        <i class="bi bi-image text-6xl mb-2"></i>
                                        <p class="text-sm">Ch∆∞a c√≥ ·∫£nh</p>
                                    </div>
                                }
                                else
                                {
                                    <img src="@previewImageUrl" alt="Preview" class="w-full h-full object-cover" />
                                    
                                    <!-- Delete Image Button (Overlay) -->
                                    <button type="button"
                                            @onclick="ClearImage"
                                            class="absolute top-2 right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">
                                        <i class="bi bi-x-lg text-sm"></i>
                                    </button>
                                }
                            </div>

                            <!-- Upload Options -->
                            <div class="mt-3 space-y-2">
                                <!-- Ch·ªçn file t·ª´ m√°y -->
                                <div>
                                    <InputFile OnChange="HandleImageSelected" 
                                               accept="image/*" 
                                               class="hidden" 
                                               id="imageUploadEdit"
                                               disabled="@hasUrlInput" />
                                    <label for="imageUploadEdit" 
                                           class="@(hasUrlInput ? "opacity-50 cursor-not-allowed" : "cursor-pointer hover:bg-gray-50") w-full px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 flex items-center justify-center gap-2">
                                        <i class="bi bi-upload"></i>
                                        Ch·ªçn ·∫£nh t·ª´ m√°y
                                    </label>
                                </div>

                                <!-- Divider -->
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 border-t border-gray-300"></div>
                                    <span class="text-xs text-gray-500 font-medium">HO·∫∂C</span>
                                    <div class="flex-1 border-t border-gray-300"></div>
                                </div>

                                <!-- URL Input -->
                                <div class="relative">
                                    <input type="text"
                                           @bind="urlInput"
                                           @bind:event="oninput"
                                           @bind:after="HandleUrlInput"
                                           disabled="@hasFileInput"
                                           class="@(hasFileInput ? "opacity-50 cursor-not-allowed" : "") w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="Nh·∫≠p URL ·∫£nh..." />
                                    @if (!string.IsNullOrEmpty(urlInput))
                                    {
                                        <button type="button"
                                                @onclick="ClearUrl"
                                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                            <i class="bi bi-x-circle-fill"></i>
                                        </button>
                                    }
                                </div>
                            </div>

                            <!-- Helper Text -->
                            <p class="mt-2 text-xs text-gray-500">
                                @if (hasFileInput)
                                {
                                    <span>‚úì ·∫¢nh t·ª´ m√°y ƒë√£ ch·ªçn. X√≥a ·∫£nh ƒë·ªÉ nh·∫≠p URL.</span>
                                }
                                else if (hasUrlInput)
                                {
                                    <span>‚úì URL ƒë√£ nh·∫≠p. X√≥a ƒë·ªÉ ch·ªçn ·∫£nh t·ª´ m√°y.</span>
                                }
                                else
                                {
                                    <span>Ch·ªçn ·∫£nh t·ª´ m√°y ho·∫∑c nh·∫≠p URL ·∫£nh</span>
                                }
                            </p>

                            <!-- Error Message -->
                            @if (!string.IsNullOrEmpty(uploadError))
                            {
                                <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
                                    <i class="bi bi-exclamation-triangle-fill text-red-500 text-sm mt-0.5"></i>
                                    <p class="text-xs text-red-600">@uploadError</p>
                                </div>
                            }
                        </div>

                        <!-- Right: Form Fields -->
                        <div class="col-span-12 md:col-span-8">
                            <div class="space-y-4">
                                
                                <!-- Row 1: T√™n & SKU -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            T√™n s·∫£n ph·∫©m <span class="text-red-500">*</span>
                                        </label>
                                        <InputText @bind-Value="editProduct.ProductName" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                   placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" />
                                        <ValidationMessage For="@(() => editProduct.ProductName)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            SKU <span class="text-red-500">*</span>
                                        </label>
                                        <InputText @bind-Value="editProduct.Sku" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-100 cursor-not-allowed"
                                                   disabled />
                                        <p class="text-xs text-gray-500 mt-1">SKU kh√¥ng th·ªÉ thay ƒë·ªïi</p>
                                    </div>
                                </div>

                                <!-- Row 2: Gi√° & ƒê∆°n v·ªã -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Gi√° b√°n <span class="text-red-500">*</span>
                                        </label>
                                        <InputNumber @bind-Value="editProduct.Price" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                     placeholder="0" />
                                        <ValidationMessage For="@(() => editProduct.Price)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            ƒê∆°n v·ªã <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.UnitId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="0">-- Ch·ªçn ƒë∆°n v·ªã --</option>
                                            @foreach (var unit in Units ?? Enumerable.Empty<UnitDTO>())
                                            {
                                                <option value="@unit.Id">@unit.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.UnitId)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                </div>

                                <!-- Row 3: Nh√† cung c·∫•p & Danh m·ª•c -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Nh√† cung c·∫•p <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.SupplierId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="0">-- Ch·ªçn nh√† cung c·∫•p --</option>
                                            @foreach (var sup in Suppliers ?? Enumerable.Empty<SupplierDTO>())
                                            {
                                                <option value="@sup.Id">@sup.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.SupplierId)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Danh m·ª•c <span class="text-red-500">*</span>
                                        </label>
                                        <InputSelect @bind-Value="editProduct.CategoryId" 
                                                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="0">-- Ch·ªçn danh m·ª•c --</option>
                                            @foreach (var cat in Categories ?? Enumerable.Empty<CategoryDTO>())
                                            {
                                                <option value="@cat.Id">@cat.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => editProduct.CategoryId)" class="text-red-500 text-xs mt-1 block" />
                                    </div>
                                </div>

                                <!-- Row 4: M√¥ t·∫£ -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">M√¥ t·∫£</label>
                                    <InputTextArea @bind-Value="editProduct.Description" 
                                                   rows="4"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 resize-none"
                                                   placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·∫£n ph·∫©m" />
                                    <ValidationMessage For="@(() => editProduct.Description)" class="text-red-500 text-xs mt-1 block" />
                                </div>

                                <!-- Row 5: Tr·∫°ng th√°i & Buttons -->
                                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                                    <label class="inline-flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" 
                                            checked="@editProduct.IsActive"
                                            @onchange="HandleIsActiveChange"
                                            class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                        <span class="text-sm font-medium text-gray-700">Hi·ªÉn th·ªã s·∫£n ph·∫©m</span>
                                    </label>
                                    <div class="flex items-center gap-3">
                                        <button type="button" 
                                                @onclick="HandleCancel"
                                                disabled="@Saving"
                                                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 text-sm font-medium disabled:opacity-50">
                                            H·ªßy
                                        </button>
                                        <button type="submit" 
                                                disabled="@Saving"
                                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium disabled:opacity-50 flex items-center gap-2">
                                            @if (Saving)
                                            {
                                                <span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                                                <span>ƒêang l∆∞u...</span>
                                            }
                                            else
                                            {
                                                <span>C·∫≠p nh·∫≠t</span>
                                            }
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>

            </EditForm>
        </div>

    </div>
</div>

@code {
    [Parameter] public ProductDTO? Product { get; set; }
    [Parameter] public List<CategoryDTO>? Categories { get; set; }
    [Parameter] public List<SupplierDTO>? Suppliers { get; set; }
    [Parameter] public List<UnitDTO>? Units { get; set; }
    [Parameter] public bool Saving { get; set; }
    [Parameter] public EventCallback<ProductDTO> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<(int, bool)> OnDelete { get; set; }

    private ProductDTO editProduct = new();
    private string? previewImageUrl = null;
    private IBrowserFile? selectedImageFile = null;
    private string? urlInput = null;
    private string? uploadError = null;
    private string? originalImageUrl = null; // L∆∞u URL ·∫£nh g·ªëc

    // Flags ƒë·ªÉ ki·ªÉm so√°t UI
    private bool hasFileInput => selectedImageFile != null;
    private bool hasUrlInput => !string.IsNullOrWhiteSpace(urlInput);

    // Public property ƒë·ªÉ ProductList l·∫•y file
    public IBrowserFile? SelectedImageFile => selectedImageFile;

    protected override void OnParametersSet()
    {
        if (Product != null)
        {
            editProduct = new ProductDTO
            {
                Id = Product.Id,
                ProductName = Product.ProductName,
                Sku = Product.Sku,
                Description = Product.Description,
                CategoryId = Product.CategoryId,
                SupplierId = Product.SupplierId,
                UnitId = Product.UnitId,
                Cost = Product.Cost,
                Price = Product.Price,
                ImageUrl = Product.ImageUrl,
                IsActive = Product.IsActive
            };

            // Kh·ªüi t·∫°o preview t·ª´ ·∫£nh hi·ªán t·∫°i
            originalImageUrl = Product.ImageUrl;
            previewImageUrl = Product.ImageUrl;
        }
    }

    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        uploadError = null;
        selectedImageFile = null;
        previewImageUrl = null;

        try
        {
            var file = e.File;

            if (file.Size > 5 * 1024 * 1024)
            {
                uploadError = "K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB";
                return;
            }

            var allowedTypes = new[] { "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp" };
            if (!allowedTypes.Contains(file.ContentType.ToLower()))
            {
                uploadError = "Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh (JPEG, PNG, GIF, WebP)";
                return;
            }

            selectedImageFile = file;

            // Generate preview
            var buffer = new byte[file.Size];
            await file.OpenReadStream(5 * 1024 * 1024).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            previewImageUrl = $"data:{file.ContentType};base64,{base64}";
        }
        catch (Exception ex)
        {
            uploadError = $"L·ªói: {ex.Message}";
        }
    }

    private void HandleUrlInput()
    {
        uploadError = null;
        
        if (string.IsNullOrWhiteSpace(urlInput))
        {
            // N·∫øu x√≥a URL, quay v·ªÅ ·∫£nh g·ªëc
            previewImageUrl = originalImageUrl;
            return;
        }

        // Validate URL format
        if (!Uri.TryCreate(urlInput, UriKind.Absolute, out var uri) && 
            !urlInput.StartsWith("/"))
        {
            uploadError = "URL kh√¥ng h·ª£p l·ªá";
            previewImageUrl = originalImageUrl;
            return;
        }

        // Set preview to URL
        previewImageUrl = urlInput;
    }

    private void ClearImage()
    {
        selectedImageFile = null;
        previewImageUrl = originalImageUrl; // Quay v·ªÅ ·∫£nh g·ªëc
        uploadError = null;
    }

    private void ClearUrl()
    {
        urlInput = null;
        previewImageUrl = originalImageUrl; // Quay v·ªÅ ·∫£nh g·ªëc
        uploadError = null;
    }

    private async Task HandleSubmit()
    {
        // N·∫øu c√≥ file t·ª´ m√°y
        if (selectedImageFile != null)
        {
            editProduct.ImageUrl = "PENDING_UPLOAD";
        }
        // N·∫øu c√≥ URL m·ªõi
        else if (!string.IsNullOrWhiteSpace(urlInput))
        {
            editProduct.ImageUrl = urlInput.Trim();
        }
        // Gi·ªØ nguy√™n ·∫£nh c≈© (kh√¥ng thay ƒë·ªïi)
        else
        {
            editProduct.ImageUrl = originalImageUrl;
        }
        
        await OnSave.InvokeAsync(editProduct);
    }

    private void HandleCancel()
    {
        if (!Saving)
        {
            OnCancel.InvokeAsync();
        }
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync((editProduct.Id, editProduct.IsActive));
    }

    private void HandleBackdropClick()
    {
        if (!Saving)
        {
            OnCancel.InvokeAsync();
        }
    }

    private async Task HandleIsActiveChange(ChangeEventArgs e)
    {
        var newValue = (bool)e.Value!;
        
        // N·∫øu ƒëang c·ªë B·∫¨T s·∫£n ph·∫©m
        if (newValue && !editProduct.IsActive)
        {
            // Ki·ªÉm tra c√≥ gi√° v·ªën kh√¥ng
            if (!editProduct.Cost.HasValue || editProduct.Cost.Value <= 0)
            {
                await JS.InvokeVoidAsync("alert", "‚ö†Ô∏è Kh√¥ng th·ªÉ b·∫≠t tr·∫°ng th√°i s·∫£n ph·∫©m!\n\n‚ùå L√Ω do: Ch∆∞a c√≥ gi√° v·ªën (Cost).\n\nüí° Vui l√≤ng nh·∫≠p gi√° v·ªën tr∆∞·ªõc khi b·∫≠t tr·∫°ng th√°i.");
                return; // Kh√¥ng cho thay ƒë·ªïi
            }
            
            // Ki·ªÉm tra gi√° b√°n ph·∫£i > gi√° v·ªën + 10%
            var minimumPrice = editProduct.Cost.Value * 1.10m;
            if (editProduct.Price < minimumPrice)
            {
                await JS.InvokeVoidAsync("alert", 
                    $"‚ö†Ô∏è Kh√¥ng th·ªÉ b·∫≠t tr·∫°ng th√°i s·∫£n ph·∫©m!\n\n" +
                    $"‚ùå L√Ω do: Gi√° b√°n ph·∫£i l·ªõn h∆°n gi√° v·ªën √≠t nh·∫•t 10%.\n\n" +
                    $"üìä Th√¥ng tin hi·ªán t·∫°i:\n" +
                    $"‚Ä¢ Gi√° v·ªën: {editProduct.Cost.Value:N0}‚Ç´\n" +
                    $"‚Ä¢ Gi√° b√°n hi·ªán t·∫°i: {editProduct.Price:N0}‚Ç´\n" +
                    $"‚Ä¢ Gi√° b√°n t·ªëi thi·ªÉu: {minimumPrice:N0}‚Ç´\n\n" +
                    $"üí° Vui l√≤ng tƒÉng gi√° b√°n l√™n √≠t nh·∫•t {minimumPrice:N0}‚Ç´ ho·∫∑c gi·∫£m gi√° v·ªën.");
                return; // Kh√¥ng cho thay ƒë·ªïi
            }
        }
        
        // N·∫øu pass t·∫•t c·∫£ validation, cho ph√©p thay ƒë·ªïi
        editProduct.IsActive = newValue;
    }
}