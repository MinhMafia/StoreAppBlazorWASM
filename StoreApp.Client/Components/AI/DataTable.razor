@using System.Text.Json
@using StoreApp.Client.Utils

@* Component hiển thị data table cho function results - Y nguyên React *@

@if (Data != null && DataArray != null && DataArray.Count > 0)
{
    @* Best sellers / Top products table *@
    @if (FunctionCalled == "get_best_sellers" || FunctionCalled == "get_top_products")
    {
        <div class="mt-3 overflow-x-auto">
            <table class="w-full text-sm border border-gray-200 rounded">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left">#</th>
                        <th class="px-3 py-2 text-left">Sản phẩm</th>
                        <th class="px-3 py-2 text-right">SL bán</th>
                        <th class="px-3 py-2 text-right">Doanh thu</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var items = DataArray.Take(10).ToList();
                        for (int idx = 0; idx < items.Count; idx++)
                        {
                            var item = items[idx];
                            <tr class="border-t">
                                <td class="px-3 py-2">@(idx + 1)</td>
                                <td class="px-3 py-2">@GetProperty(item, "productName")</td>
                                <td class="px-3 py-2 text-right">@GetProperty(item, "quantitySold")</td>
                                <td class="px-3 py-2 text-right">@Formatters.FormatCurrency(GetDecimalProperty(item, "revenue"))</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }

    @* Low stock table *@
    else if (FunctionCalled == "get_low_stock")
    {
        <div class="mt-3 overflow-x-auto">
            <table class="w-full text-sm border border-gray-200 rounded">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left">Sản phẩm</th>
                        <th class="px-3 py-2 text-left">SKU</th>
                        <th class="px-3 py-2 text-right">Tồn kho</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in DataArray.Take(10))
                    {
                        var quantity = GetIntProperty(item, "quantity");
                        var colorClass = quantity < 5 ? "text-red-600" : "text-orange-500";
                        <tr class="border-t">
                            <td class="px-3 py-2">@GetProperty(item, "productName")</td>
                            <td class="px-3 py-2 text-gray-500">@(GetProperty(item, "sku") ?? "-")</td>
                            <td class="px-3 py-2 text-right font-semibold @colorClass">
                                @quantity
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @* Top customers table *@
    else if (FunctionCalled == "get_top_customers")
    {
        <div class="mt-3 overflow-x-auto">
            <table class="w-full text-sm border border-gray-200 rounded">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left">#</th>
                        <th class="px-3 py-2 text-left">Khách hàng</th>
                        <th class="px-3 py-2 text-right">Số đơn</th>
                        <th class="px-3 py-2 text-right">Tổng chi</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var items = DataArray.Take(10).ToList();
                        for (int idx = 0; idx < items.Count; idx++)
                        {
                            var item = items[idx];
                            <tr class="border-t">
                                <td class="px-3 py-2">@(idx + 1)</td>
                                <td class="px-3 py-2">@GetProperty(item, "customerName")</td>
                                <td class="px-3 py-2 text-right">@GetProperty(item, "orderCount")</td>
                                <td class="px-3 py-2 text-right">@Formatters.FormatCurrency(GetDecimalProperty(item, "totalSpent"))</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
}

@code {
    [Parameter]
    public object? Data { get; set; }

    [Parameter]
    public string? FunctionCalled { get; set; }

    private List<JsonElement>? DataArray { get; set; }

    protected override void OnParametersSet()
    {
        if (Data != null)
        {
            try
            {
                var json = JsonSerializer.Serialize(Data);
                var element = JsonSerializer.Deserialize<JsonElement>(json);

                if (element.ValueKind == JsonValueKind.Array)
                {
                    DataArray = element.EnumerateArray().ToList();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error parsing data: {ex.Message}");
                DataArray = null;
            }
        }
        else
        {
            DataArray = null;
        }
    }

    private string? GetProperty(JsonElement element, string propertyName)
    {
        if (element.ValueKind == JsonValueKind.Object && element.TryGetProperty(propertyName, out var value))
        {
            return value.ValueKind switch
            {
                JsonValueKind.String => value.GetString(),
                JsonValueKind.Number => value.ToString(),
                JsonValueKind.Null => null,
                _ => value.ToString()
            };
        }
        return null;
    }

    private int GetIntProperty(JsonElement element, string propertyName)
    {
        if (element.ValueKind == JsonValueKind.Object && element.TryGetProperty(propertyName, out var value))
        {
            if (value.ValueKind == JsonValueKind.Number && value.TryGetInt32(out var intValue))
            {
                return intValue;
            }
        }
        return 0;
    }

    private decimal GetDecimalProperty(JsonElement element, string propertyName)
    {
        if (element.ValueKind == JsonValueKind.Object && element.TryGetProperty(propertyName, out var value))
        {
            if (value.ValueKind == JsonValueKind.Number && value.TryGetDecimal(out var decimalValue))
            {
                return decimalValue;
            }
        }
        return 0;
    }
}
