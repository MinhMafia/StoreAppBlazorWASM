@using Blazored.LocalStorage
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorage
@implements IAsyncDisposable

@code {
    private IJSObjectReference? _jsModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Kiểm tra có token trong LocalStorage không
                var token = await LocalStorage.GetItemAsStringAsync("authToken");

                if (string.IsNullOrEmpty(token))
                {
                    // Không có token = chưa đăng nhập, không load Tawk.to
                    return;
                }

                // Lấy userName từ LocalStorage
                var userName = await LocalStorage.GetItemAsStringAsync("userName");
                var userNameJs = !string.IsNullOrEmpty(userName)
                ? userName.Replace("\\", "\\\\").Replace("'", "\\'").Replace("\"", "\\\"").Replace("\n", "\\n").Replace("\r", "\\r")
                : "";

                // Có token = đã đăng nhập, load Tawk.to để hỗ trợ
                // Check if Tawk.to is already loaded
                var isLoaded = await JSRuntime.InvokeAsync<bool>("eval", "typeof window.Tawk_API !== 'undefined'");

                if (!isLoaded)
                {
                    // Load Tawk.to script dynamically
                    await JSRuntime.InvokeVoidAsync("eval", @"
(function() {
window.Tawk_API = window.Tawk_API || {};

// --- MOVE WIDGET UP (không đụng DOM) ---
// br = bottom-right, tăng yOffset => đẩy lên trên
// tăng xOffset => đẩy qua trái (nếu cần né AI chat)
window.Tawk_API.customStyle = {
visibility: {
desktop: { position: 'br', xOffset: 20, yOffset: 120 },
mobile: { position: 'br', xOffset: 20, yOffset: 220 }
}
};
// --------------------------------------

window.Tawk_LoadStart = new Date();
var s1 = document.createElement('script');
var s0 = document.getElementsByTagName('script')[0];
s1.async = true;
s1.src = 'https://embed.tawk.to/693562e6459173197e853e08/1jbs8klc5';
s1.charset = 'UTF-8';
s1.setAttribute('crossorigin', '*');
s0.parentNode.insertBefore(s1, s0);
})();
");
                }

                // Đợi Tawk.to load xong rồi set userName
                await Task.Delay(2000);

                // Set userName vào Tawk.to
                if (!string.IsNullOrEmpty(userNameJs))
                {
                    await JSRuntime.InvokeVoidAsync("eval", $@"
(function() {{
var userName = '{userNameJs}';
var attributes = {{ 'name': userName }};

if (window.Tawk_API) {{
if (window.Tawk_API.setAttributes) {{
// Tawk.to đã load, set ngay
window.Tawk_API.setAttributes(attributes, function(error) {{
if (error) {{
console.error('[TawkToWidget] ❌ setAttributes error:', error);
}} else {{
console.log('[TawkToWidget] ✅ Name set successfully:', userName);
}}
}});
}} else {{
// Chưa load, đợi onLoad callback
window.Tawk_API.onLoad = function() {{
window.Tawk_API.setAttributes(attributes, function(error) {{
if (error) {{
console.error('[TawkToWidget] ❌ setAttributes error:', error);
}} else {{
console.log('[TawkToWidget] ✅ Name set successfully:', userName);
}}
}});
}};
}}
}} else {{
// Retry sau 2 giây
setTimeout(function() {{
if (window.Tawk_API && window.Tawk_API.onLoad) {{
window.Tawk_API.onLoad = function() {{
window.Tawk_API.setAttributes(attributes, function(error) {{
if (error) {{
console.error('[TawkToWidget] ❌ setAttributes error:', error);
}} else {{
console.log('[TawkToWidget] ✅ Name set successfully:', userName);
}}
}});
}};
}}
}}, 2000);
}}
}})();
");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading Tawk.to: {ex.Message}");
            }
        }
    }


    public async ValueTask DisposeAsync()
    {
        // Cleanup if needed
        if (_jsModule != null)
        {
            await _jsModule.DisposeAsync();
        }
    }
}