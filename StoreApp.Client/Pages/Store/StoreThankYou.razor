@page "/store/thankyou"
@layout StoreLayout
@using StoreApp.Shared
@inject HttpClient Http

@inject IOrdersClientService _ordersClient
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Đặt hàng thành công</PageTitle>

<!-- BẮT BUỘC: Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Tailwind CDN + Config màu custom -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#4ade80',
                    primaryDark: '#22c55e',
                    primaryLight: '#86efac',
                    success: '#10b981',
                    momo: '#d82d8b'
                }
            }
        }
    }
</script>

<style>
    /* Reset font vừa mắt, không bị to quá */
    body {
        font-family: system-ui, -apple-system, sans-serif;
    }

    h1,
    h2,
    h3,
    h4 {
        line-height: 1.3;
    }
</style>

@if (isLoading)
{
    <div class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-primary text-6xl mb-4"></i>
            <p class="text-xl">Đang tải thông tin đơn hàng...</p>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="max-w-2xl mx-auto text-center py-20">
        <i class="fas fa-exclamation-triangle text-red-500 text-8xl mb-6"></i>
        <h2 class="text-4xl font-bold text-red-600 mb-4">Không thể tải đơn hàng</h2>
        <p class="text-lg text-gray-700 mb-8">@errorMessage</p>
        <a href="/store/products" class="bg-primary hover:bg-primaryDark text-white font-bold py-4 px-10 rounded-xl text-lg">
            Quay lại mua sắm
        </a>
    </div>
}
else
{
    <div class="max-w-7xl mx-auto px-4 py-8 sm:py-12">

        <!-- Header thành công -->
        <div class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-24 h-24 sm:w-32 sm:h-32 bg-success/10 rounded-full mb-6">
                <i class="fas fa-check-circle text-success text-6xl sm:text-8xl"></i>
            </div>
            <h1 class="text-3xl sm:text-5xl font-bold text-success mb-3">ĐẶT HÀNG THÀNH CÔNG!</h1>
            <p class="text-lg sm:text-xl text-gray-600">Đơn hàng của bạn đã được ghi nhận. FreshMart đang chuẩn bị giao
                ngay!</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-6 lg:gap-8">

            <!-- CỘT TRÁI -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Thông tin đơn hàng -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-5">Thông tin đơn hàng</h3>
                    <div class="grid grid-cols-2 gap-4 text-base">
                        <div>
                            <p class="text-gray-500 text-sm">Mã đơn hàng</p>
                            <p class="font-bold text-primaryDark text-lg">@order.OrderNumber</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Thời gian đặt</p>
                            <p class="font-bold">@order.CreatedAt.ToString("dd/MM/yyyy - HH:mm")</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Trạng thái</p>
                            <p class="font-bold text-orange-600">Đang chờ xử lí</p>
                        </div>

                    </div>
                </div>

                <!-- Thông tin nhận hàng -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-5">Thông tin nhận hàng</h3>
                    <div class="space-y-4 text-base">
                        <div class="flex justify-between"><span class="text-gray-500">Khách hàng</span><span
                                class="font-bold">@order.CustomerName</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Số điện thoại</span><span
                                class="font-bold">@order.SoDienThoai</span></div>
                        <div class="flex justify-between items-start"><span class="text-gray-500">Địa chỉ giao</span><span
                                class="font-medium text-right max-w-48">@order.DiaChiKhachHang</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Ghi chú</span><span
                                class="italic text-gray-600 text-right max-w-48">@order.Note</span>
                        </div>
                    </div>
                </div>

                <!-- Danh sách sản phẩm -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                    <div class="bg-gradient-to-r from-primary to-primaryDark text-white p-4 sm:p-6">
                        <h3 class="text-xl sm:text-2xl font-bold">SẢN PHẨM MUỐN MUA</h3>
                    </div>

                    <div class="max-h-96 overflow-y-auto divide-y divide-gray-100">
                    @if (listorderProduct.Count == 0)
                    {
                        <div class="flex gap-4 p-5 hover:bg-primaryLight/5 transition">
                            Có vấn đề xảy ra
                        </div>
                    }
                    else
                    {
                        @foreach (var item in listorderProduct)
                        {
                            <div class="flex gap-4 p-5 hover:bg-primaryLight/5 transition">
                                <img class="w-20 h-20 object-cover rounded-xl shadow" src="@item.img" alt="SP">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-gray-800 line-clamp-2">@item.product</h4>
                                    <div class="flex items-center gap-3 mt-2 text-sm">
                                        <span class="bg-primaryLight text-primaryDark px-3 py-1 rounded-full font-bold">@item.qty</span>
                                        <span class="text-gray-600">×</span>
                                        <span class="font-medium">@item.price ₫</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-primaryDark">@item.total₫</p>
                                </div>
                            </div>
                        }
                    }
                       


                    </div>
                </div>

            </div>

            <!-- CỘT PHẢI -->
            <div class="space-y-6">

             
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold mb-4">Khuyến mãi</h3>
                        <div class="p-4 bg-primaryLight/20 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-check-circle text-primary text-xl"></i>
                                <div>
                                    <p class="font-bold text-primary">
                                         @(string.IsNullOrWhiteSpace(order.PromotionCode) 
                                            ? "Không dùng khuyến mãi" 
                                            : order.PromotionCode)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                

                <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-lg font-bold mb-4">Thanh toán</h3>
                    @if(order.PaymentMethod=="other"){
                        <div class="p-5 bg-gradient-to-br from-momo/10 to-pink-50 rounded-xl border-2 border-momo">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" class="h-9">
                                    <div>
                                        <p class="font-bold text-momo">Ví MoMo</p>
                                        <p class="text-sm text-green-600 font-bold">
                                            Đã thanh toán
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right text-sm">
                                    
                                    <p class="text-green-600 font-bold">Thành công</p>
                                    <p class="text-gray-500">GD: @order.TransactionRef</p>
                                    
                                </div>
                            </div>
                        </div>

                    }else{
                        <div class="p-5 bg-gradient-to-br from-yellow-50 to-green-50 rounded-xl border-2 border-green-400">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <svg class="w-9 h-9 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 12v-2m-9-6h18" />
                                    </svg>
                                    <div>
                                        <p class="font-bold text-green-700">Tiền mặt (Cash)</p>
                                        <p class="text-sm text-yellow-700 font-bold">Chưa thanh toán</p>
                                    </div>
                                </div>
                                <div class="text-right text-sm">
                                    <p class="text-gray-600 font-semibold">Thanh toán khi nhận hàng</p>
                                </div>
                            </div>
                        </div>
                    }




                </div>

                <div class="bg-gradient-to-br from-primary to-primaryDark text-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-bold mb-5">Tóm tắt thanh toán</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between"><span>Tạm tính</span><span>@order.Subtotal</span></div>
                        <div class="flex justify-between text-yellow-300 font-bold"><span>Giảm
                                giá</span><span>- {@order.Discount} </span></div>
                        <div class="border-t border-white/30 pt-3 mt-3">
                            <div class="flex justify-between text-2xl font-bold">
                                <span>Tổng tiền</span>
                                <span>@order.TotalAmount </span>
                            </div>
                        </div>
                    </div>

                    <a href="/store/products"
                        class="block text-center mt-6 bg-white/20 hover:bg-white/30 py-4 rounded-xl font-bold text-lg transition">
                        Tiếp tục mua sắm
                    </a>
                </div>

            </div>
        </div>
    </div>

}


@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "orderId")]
    public string? OrderId { get; set; }

    private OrderDTO? order;

    private List<OrderItemReponse> listorderProduct = new List<OrderItemReponse>();

    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Cách mới .NET 8+ – tự động lấy orderId từ query string
            if (string.IsNullOrWhiteSpace(OrderId) || !int.TryParse(OrderId, out int orderIdNumber))
            {
                errorMessage = "Mã đơn hàng không hợp lệ.";
                return;
            }

            // Gọi 2 API song song cho nhanh
            var orderTask = _ordersClient.GetOrderDTOAsync(orderIdNumber);
            var itemsTask = _ordersClient.GetOrderItemsByOrderIdAsync(orderIdNumber);

            await Task.WhenAll(orderTask, itemsTask);

            order = await orderTask;
            listorderProduct = await itemsTask;

            if (order == null || listorderProduct == null)
            {
                errorMessage = "Không tìm thấy đơn hàng hoặc danh sách sản phẩm.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Có lỗi xảy ra khi tải thông tin đơn hàng. Vui lòng thử lại sau.";
            // Có thể log ex ở đây nếu cần
        }
        finally
        {
            // QUAN TRỌNG NHẤT: DÙ THÀNH CÔNG HAY LỖI ĐỀU PHẢI TẮT LOADING
            isLoading = false;
        
        }
    }


}

                    
