@page "/store/profile"
@layout StoreLayout
@inject IMeClientService MeClientService
@using System.Text.RegularExpressions

<PageTitle>Hồ sơ cá nhân</PageTitle>

<div class="max-w-4xl mx-auto px-4 py-10 space-y-6">
    <div class="flex items-start justify-between gap-4">
        <div>
            <p class="text-xs uppercase tracking-widest text-emerald-600 font-semibold">Tài khoản</p>
            <h1 class="text-3xl font-bold text-gray-800 mt-1">Hồ sơ cá nhân</h1>
            <p class="text-sm text-gray-500">Xem thông tin đăng nhập và cập nhật tên hiển thị.</p>
        </div>
        <button class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition"
                @onclick="OpenPasswordModal">
            Đổi mật khẩu
        </button>
    </div>

    @if (alert is not null)
    {
        <div class="@GetAlertClass(alert)">
            @alert.Message
        </div>
    }

    <div class="bg-white rounded-2xl shadow border border-gray-100 p-6">
        @if (isLoading)
        {
            <div class="flex items-center gap-2 text-gray-500 text-sm">
                <span class="inline-block w-4 h-4 border-2 border-emerald-200 border-t-emerald-600 rounded-full animate-spin"></span>
                Đang tải thông tin...
            </div>
        }
        else
        {
            <EditForm Model="@profileForm" OnSubmit="@HandleProfileSubmit" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Username</label>
                        <input class="mt-1 w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-gray-700"
                               value="@profileForm.Username"
                               readonly />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input class="mt-1 w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-gray-700"
                               value="@profileForm.Email"
                               readonly />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Họ tên</label>
                    <input class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200"
                           @bind="profileForm.FullName"
                           placeholder="Nhập họ tên của bạn" />
                </div>

                <div class="flex items-center justify-end gap-3 pt-2">
                    <button type="button"
                            class="px-4 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50"
                            @onclick="LoadProfileAsync"
                            disabled="@isSaving">
                        Tải lại
                    </button>
                    <button type="submit"
                            class="px-5 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition disabled:opacity-60"
                            disabled="@isSaving">
                        @(isSaving ? "Đang lưu..." : "Lưu thay đổi")
                    </button>
                </div>
            </EditForm>
        }
    </div>
</div>

@if (showPasswordModal)
{
    <div class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 px-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl border border-gray-100 p-6 relative">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
                    @onclick="ClosePasswordModal">
                ✕
            </button>

            <h2 class="text-xl font-semibold text-gray-800 mb-2">Đổi mật khẩu</h2>
            <p class="text-sm text-gray-500 mb-4">Nhập mật khẩu hiện tại và đặt mật khẩu mới cho tài khoản.</p>

            @if (passwordAlert is not null)
            {
                <div class="@GetAlertClass(passwordAlert)">
                    @passwordAlert.Message
                </div>
            }

            <EditForm Model="@passwordForm" OnSubmit="@HandlePasswordSubmit" class="space-y-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Mật khẩu hiện tại</label>
                    <div class="relative">
                        <input class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 pr-12 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200"
                               type="@(showCurrentPassword ? "text" : "password")"
                               @bind="passwordForm.CurrentPassword"
                               required />
                        <button type="button"
                                class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700"
                                @onclick="() => showCurrentPassword = !showCurrentPassword">
                            <i class="bi @(showCurrentPassword ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Mật khẩu mới</label>
                    <div class="relative">
                        <input class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 pr-12 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200"
                               type="@(showNewPassword ? "text" : "password")"
                               @bind="passwordForm.NewPassword"
                               minlength="6"
                               required />
                        <button type="button"
                                class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700"
                                @onclick="() => showNewPassword = !showNewPassword">
                            <i class="bi @(showNewPassword ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Xác nhận mật khẩu mới</label>
                    <div class="relative">
                        <input class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 pr-12 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200"
                               type="@(showConfirmPassword ? "text" : "password")"
                               @bind="passwordForm.ConfirmNewPassword"
                               minlength="6"
                               required />
                        <button type="button"
                                class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700"
                                @onclick="() => showConfirmPassword = !showConfirmPassword">
                            <i class="bi @(showConfirmPassword ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button"
                            class="px-4 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50"
                            @onclick="ClosePasswordModal"
                            disabled="@isPasswordSaving">
                        Hủy
                    </button>
                    <button type="submit"
                            class="px-5 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition disabled:opacity-60"
                            disabled="@isPasswordSaving">
                        @(isPasswordSaving ? "Đang lưu..." : "Đổi mật khẩu")
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private static readonly Regex EmailRegex = new(@"^[^\s@]+@[^\s@]+\.[^\s@]+$", RegexOptions.Compiled);

    private ProfileForm profileForm = new();
    private PasswordForm passwordForm = new();
    private AlertMessage? alert;
    private AlertMessage? passwordAlert;
    private bool isLoading = true;
    private bool isSaving;
    private bool isPasswordSaving;
    private bool showPasswordModal;
    private bool showCurrentPassword;
    private bool showNewPassword;
    private bool showConfirmPassword;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfileAsync();
    }

    private async Task LoadProfileAsync()
    {
        isLoading = true;
        alert = null;

        try
        {
            var data = await MeClientService.GetProfileAsync();
            if (data == null)
            {
                alert = AlertMessage.Error("Không thể tải thông tin cá nhân.");
                return;
            }

            profileForm = new ProfileForm
            {
                Username = data.Username ?? string.Empty,
                Email = data.Email ?? string.Empty,
                FullName = data.FullName ?? string.Empty
            };
        }
        catch (Exception ex)
        {
            alert = AlertMessage.Error(ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleProfileSubmit(EditContext _)
    {
        var trimmedUsername = (profileForm.Username ?? string.Empty).Trim();
        var trimmedEmail = (profileForm.Email ?? string.Empty).Trim();

        if (trimmedUsername.Length < 3)
        {
            alert = AlertMessage.Error("Username phải có ít nhất 3 ký tự.");
            return;
        }

        if (!EmailRegex.IsMatch(trimmedEmail))
        {
            alert = AlertMessage.Error("Email không hợp lệ.");
            return;
        }

        isSaving = true;
        alert = null;

        try
        {
            var payload = new MeDTO
            {
                Username = trimmedUsername,
                Email = trimmedEmail,
                FullName = string.IsNullOrWhiteSpace(profileForm.FullName) ? string.Empty : profileForm.FullName.Trim()
            };

            var updated = await MeClientService.UpdateProfileAsync(payload);
            profileForm = new ProfileForm
            {
                Username = updated.Username ?? trimmedUsername,
                Email = updated.Email ?? trimmedEmail,
                FullName = updated.FullName ?? profileForm.FullName
            };

            alert = AlertMessage.Success("Thông tin cá nhân đã được cập nhật.");
        }
        catch (Exception ex)
        {
            alert = AlertMessage.Error(ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandlePasswordSubmit(EditContext _)
    {
        passwordAlert = null;

        if (passwordForm.NewPassword != passwordForm.ConfirmNewPassword)
        {
            passwordAlert = AlertMessage.Error("Mật khẩu xác nhận không khớp.");
            return;
        }

        isPasswordSaving = true;

        try
        {
            var request = new MeDTO
            {
                CurrentPassword = passwordForm.CurrentPassword,
                NewPassword = passwordForm.NewPassword,
                ConfirmNewPassword = passwordForm.ConfirmNewPassword
            };

            await MeClientService.ChangePasswordAsync(request);

            passwordForm = new PasswordForm();
            showPasswordModal = false;
            alert = AlertMessage.Success("Mật khẩu đã được thay đổi.");
        }
        catch (Exception ex)
        {
            passwordAlert = AlertMessage.Error(ex.Message);
        }
        finally
        {
            isPasswordSaving = false;
        }
    }

    private void OpenPasswordModal()
    {
        passwordAlert = null;
        passwordForm = new PasswordForm();
        showCurrentPassword = false;
        showNewPassword = false;
        showConfirmPassword = false;
        showPasswordModal = true;
    }

    private void ClosePasswordModal()
    {
        passwordAlert = null;
        showPasswordModal = false;
    }

    private static string GetAlertClass(AlertMessage message)
    {
        var tone = message.Type == "success"
            ? "bg-emerald-50 text-emerald-700 border border-emerald-100"
            : "bg-red-50 text-red-700 border border-red-100";

        return $"rounded-lg px-4 py-3 text-sm {tone}";
    }

    private sealed class ProfileForm
    {
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? FullName { get; set; } = string.Empty;
    }

    private sealed class PasswordForm
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmNewPassword { get; set; } = string.Empty;
    }

    private sealed record AlertMessage(string Type, string Message)
    {
        public static AlertMessage Success(string message) => new("success", message);
        public static AlertMessage Error(string message) => new("error", message);
    }
}
