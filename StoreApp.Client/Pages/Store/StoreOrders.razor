@page "/store/orders"
@layout StoreLayout
@using StoreApp.Shared
@inject IOrdersClientService OrdersClientService
@inject IJSRuntime JSRuntime

<PageTitle>Đơn hàng của tôi - Cửa hàng tiện lợi</PageTitle>

<div class="max-w-6xl mx-auto px-4 py-10 space-y-6">
    <div class="flex items-center justify-between gap-3">
        <div>
            <p class="text-sm text-gray-500 uppercase">Tài khoản</p>
            <h1 class="text-2xl font-bold text-gray-800">Lịch sử mua hàng</h1>
        </div>
        <a class="text-primary font-semibold hover:text-green-700" href="/store">Tiếp tục mua sắm</a>
    </div>

    @if (isLoading)
    {
        <div class="bg-white rounded-xl shadow p-6 text-gray-500">Đang tải đơn hàng...</div>
    }
    else if (!string.IsNullOrEmpty(error))
    {
        <div class="bg-red-50 border border-red-200 text-red-700 rounded-xl p-4">@error</div>
    }
    else if (orders.Count == 0)
    {
        <div class="bg-white rounded-xl shadow p-6 text-gray-600">
            <p>Bạn chưa có đơn hàng nào.</p>
            <a class="text-primary font-semibold hover:text-green-700" href="/store">Mua sắm ngay</a>
        </div>
    }
    else
    {
        <div class="space-y-4">
            @foreach (var o in orders.OrderByDescending(x => x.CreatedAt))
            {
                <div class="bg-white rounded-xl shadow hover:shadow-lg transition border border-gray-100">
                    <div class="p-5 flex flex-col md:flex-row md:items-center justify-between gap-3 border-b border-gray-100">
                        <div class="space-y-1">
                            <div class="flex flex-wrap items-center gap-2">
                                <span class="text-lg font-semibold text-gray-800">#@o.OrderNumber</span>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold text-white @(GetStatusColor(o.Status))">
                                    @DisplayStatus(o.Status)
                                </span>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold text-white @(GetPaymentColor(o.PaymentStatus))">
                                    @(string.IsNullOrWhiteSpace(o.PaymentStatus) ? "Chưa rõ" : o.PaymentStatus)
                                </span>
                            </div>
                            <p class="text-sm text-gray-500">@o.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Tổng thanh toán</p>
                            <p class="text-2xl font-bold text-green-600">@o.TotalAmount.ToString("N0") đ</p>
                        </div>
                    </div>
                    <div class="px-5 py-4 flex items-center justify-between text-sm text-gray-600">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex items-center gap-2">
                                <i class="bi bi-person"></i>
                                <span>@(string.IsNullOrWhiteSpace(o.CustomerName) ? "Bạn" : o.CustomerName)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="bi bi-telephone"></i>
                                <span>@(string.IsNullOrWhiteSpace(o.SoDienThoai) ? "—" : o.SoDienThoai)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="bi bi-geo-alt"></i>
                                <span>@(string.IsNullOrWhiteSpace(o.DiaChiKhachHang) ? "—" : o.DiaChiKhachHang)</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            @if (CanCancelOrder(o))
                            {
                                <button @onclick="() => CancelOrderAsync(o.Id)" 
                                    class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition flex items-center gap-2">
                                    <i class="bi bi-x-circle"></i>
                                    Hủy đơn
                                </button>
                            }
                            <a class="text-primary font-semibold hover:text-green-700 flex items-center gap-1" href="@($"/store/orders/{o.Id}")">
                                Xem chi tiết <i class="bi bi-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<OrderDTO> orders = new();
    private bool isLoading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        isLoading = true;
        error = null;
        try
        {
            orders = await OrdersClientService.GetMyOrdersAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetStatusColor(string? status)
    {
        return status?.ToLower() switch
        {
            "paid" or "completed" => "bg-green-500",
            "cancelled" => "bg-red-500",
            "pending" => "bg-amber-500",
            _ => "bg-gray-500"
        };
    }

    private string GetPaymentColor(string? paymentStatus)
    {
        return paymentStatus?.ToLower() switch
        {
            "completed" or "paid" => "bg-green-500",
            "pending" => "bg-amber-500",
            "failed" => "bg-red-500",
            _ => "bg-gray-500"
        };
    }

    private string DisplayStatus(string? status)
    {
        return status?.ToLower() switch
        {
            "paid" => "Đã thanh toán",
            "completed" => "Hoàn tất",
            "pending" => "Đang xử lý",
            "cancelled" => "Đã hủy",
            _ => status ?? "Không rõ"
        };
    }

    private bool CanCancelOrder(OrderDTO order)
    {
        // Chỉ cho phép hủy đơn hàng có trạng thái pending
        // Không cho hủy đơn đã hoàn thành hoặc đã hủy
        return order.Status?.ToLower() == "pending";
    }

    private async Task CancelOrderAsync(int orderId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn hủy đơn hàng này?"))
            return;

        try
        {
            isLoading = true;
            var success = await OrdersClientService.CancelMyOrderAsync(orderId);
            
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Đã hủy đơn hàng thành công!");
                await LoadOrdersAsync(); // Reload danh sách
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Không thể hủy đơn hàng. Vui lòng thử lại sau.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
