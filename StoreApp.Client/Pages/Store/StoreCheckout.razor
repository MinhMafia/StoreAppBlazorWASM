@page "/store/checkout"
@inject NavigationManager Navigation
@inject IStoreCartService CartService
@inject IOrdersClientService _ordersClient
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject IMeClientService MeClient
@inject IJSRuntime JS
@layout StoreLayout
@using Microsoft.AspNetCore.WebUtilities
@using StoreApp.Client.Pages.Auth

<PageTitle>Đặt hàng - FreshMart</PageTitle>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<div class="max-w-7xl mx-auto px-4 py-10 bg-gray-50 min-h-screen">
    <h2 class="text-3xl lg:text-4xl font-bold text-center text-gray-800 mb-10">Xác nhận & Thanh toán</h2>

    @if (isLoading == true)
    {
        <div class="text-center py-20">
            <p class="text-xl">Đang tải đơn hàng của bạn...</p>
        </div>
    }
    else
    {
        <div class="grid lg:grid-cols-3 gap-8">

            <!-- CỘT TRÁI -->
            <div class="lg:col-span-2 space-y-8">

                <!-- 1. Thông tin khách hàng -->
                <!-- 1. Thông tin khách hàng – PHIÊN BẢN NHỎ GỌN & HIỆN ĐẠI -->
                <div class="bg-white rounded-3xl shadow-soft p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-3">
                        <i class="fas fa-user text-primary"></i> Thông tin nhận hàng của đơn ( @currentOrder.OrderNumber )
                    </h3>

                    <div class="grid md:grid-cols-2 gap-4"> <!-- giảm gap-6 → gap-4 -->
                        <input type="text" id="full_name" value="@currentOrder.CustomerName"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-4 focus:ring-primary/20 transition text-base"
                            required>

                        <input type="tel" id="phone" value="@currentOrder.SoDienThoai"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-4 focus:ring-primary/20 transition text-base"
                            required>

                        <input type="email" id="email" value="@(currentOrder.Email ?? "khachhang@gmail.com")"
                            class="md:col-span-2 w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-4 focus:ring-primary/20 transition text-base">

                        <textarea id="address" rows="3"
                        value="@(currentOrder.DiaChiKhachHang ?? "273 An Dương Vương, Phường Chợ Quán, TP. HCM")"
                        class="md:col-span-2 w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-4 focus:ring-primary/20 transition text-base resize-none"
                        required></textarea>

                        <textarea id="note" rows="2" placeholder="Ghi chú (giao giờ nào, để trước cửa...)"
                            @bind="currentOrder.Note"
                            class="md:col-span-2 w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-4 focus:ring-primary/20 transition text-base resize-none"></textarea>
                    </div>
                </div>


                <div class="bg-white rounded-3xl shadow-soft overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                            <i class="fas fa-box text-primary"></i> DANH SÁCH SẢN PHẨM
                        </h3>
                    </div>


                    <div class="max-h-96 overflow-y-auto divide-y divide-gray-100">
                        @if (checkoutItems.Count == 0)
                        {
                            <div class="flex items-center gap-4 py-4 px-6 hover:bg-gray-50 transition">
                                Không có sản phẩm nào
                            </div>
                        }
                        else
                        {

                            @foreach (var item in checkoutItems)
                            {
                                <div class="flex items-center gap-4 py-4 px-6 hover:bg-gray-50 transition">
                                    <img src="@item.ImageUrl" class="w-16 h-16 object-cover rounded-lg shadow-sm flex-shrink-0">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-gray-800 text-base line-clamp-2">@item.ProductName</h4>
                                        <p class="text-sm text-gray-500 mt-0.5">@item.Quantity × @item.Price</p>
                                    </div>
                                    <span class="text-base font-semibold text-primaryDark whitespace-nowrap">@item.Total ₫</span>
                                </div>

                            }

                            @* currentOrder.TotalAmount = tongTien + 30000; *@

                        }


                    </div>
                </div>


                <div class="bg-white rounded-3xl shadow-soft p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-3">
                        <i class="fas fa-tag text-primary"></i> Chọn khuyến mãi
                    </h3>
                    <div class="space-y-3">
                        @if (promotions.Count == 0)
                        {
                            <label
                                class="flex items-center justify-between p-4 border-2 border-orange-300 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition cursor-pointer">
                                <div class="flex items-center gap-3">
                                    KHÔNG CÓ KHUYẾN MÃI NÀO
                                </div>
                            </label>

                        }
                        else
                        {

                            @foreach (var item in promotions)
                            {
                                <label @onclick="() => HandleSelect(item)"
                                    class="flex items-center justify-between p-4 border-2 border-orange-300 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div>
                                            <div class="font-semibold text-orange-600">@item.Code</div>
                                            <div class="text-xs text-gray-600">
                                                @if (item.Type == "percent")
                                                {
                                                    @($"Giảm {item.Value}%")
                                                }
                                                else
                                                {
                                                    @($"Giảm {item.Value:C0}₫")
                                                }
                                                @if (item.MinOrderAmount > 0)
                                                {
                                                    @($" • Tối thiểu {item.MinOrderAmount:C0}₫")
                                                }

                                            </div>

                                            @if (!string.IsNullOrEmpty(item.Description))
                                            {
                                                <div class="text-sm text-gray-500 mt-1">@item.Description</div>
                                            }

                                        </div>
                                    </div>

                                    <i class="fas fa-gift text-orange-600"></i>
                                </label>
                            }
                        }

                    </div>
                </div>


                <div class="bg-white rounded-3xl shadow-soft p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-3">
                        <i class="fas fa-credit-card text-primary"></i> Phương thức thanh toán
                    </h3>
                    <div class="space-y-3">
                        <label
                            class="flex items-center justify-between p-4 border-2 border-primary rounded-xl bg-primary/5">
                            <div class="flex items-center gap-3">
                                <input value="cash" @onchange="@(() => SetPaymentMethod("cash"))" type="radio"
                                    name="payment" class="w-4 h-4 text-primary" />
                                <div>
                                    <div class="font-medium text-base">Thanh toán khi nhận hàng (COD)</div>
                                    <div class="text-xs text-gray-600">Trả tiền mặt khi nhận hàng</div>
                                </div>
                            </div>
                            <i class="fas fa-money-bill-wave text-primary text-xl"></i>
                        </label>

                        <label
                            class="flex items-center justify-between p-4 border-2 border-pink-400 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition">
                            <div class="flex items-center gap-3">
                                <input type="radio" value="other" checked="@(currentOrder.PaymentMethod == "other")"
                                    @onchange="@(() => SetPaymentMethod("other"))" name="payment"
                                    class="w-4 h-4 text-pink-600">
                                <div>
                                    <div class="font-medium text-pink-600 text-base">Ví Momo</div>
                                    <div class="text-xs text-gray-600">Nhận thêm ưu đãi từ Momo</div>
                                </div>
                            </div>
                            <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" alt="Momo" class="h-8">
                        </label>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-1">
                <div class="bg-white rounded-3xl shadow-soft p-8 sticky top-28">
                    <h3 class="text-2xl font-bold text-gray-800 mb-8">Tóm tắt đơn hàng</h3>

                    <div class="space-y-5 text-lg">
                        <div class="flex justify-between">
                            <span>Tạm tính</span>
                            <span id="subtotal" class="font-semibold">@currentOrder.Subtotal.ToString() ₫</span>
                        </div>

                        <div class="flex justify-between text-primary font-bold text-lg">
                            <span>Giảm giá</span>
                            <span id="discount">- @currentOrder.Discount ₫</span>
                        </div>
                        <div class="border-t-4 border-dashed border-primaryLight pt-6 mt-6">
                            <div class="flex justify-between text-3xl font-bold text-primaryDark">
                                <span>Tổng cộng</span>
                                <span id="final-total">@currentOrder.TotalAmount.ToString() ₫</span>
                            </div>
                        </div>

                        <button id="place-order-btn" @onclick="createNewOrder"
                            class="w-full mt-8 bg-gradient-to-r from-primary to-primaryHover text-white font-bold text-2xl py-6 rounded-2xl shadow-strong hover:shadow-2xl transform hover:scale-105 transition-all duration-500 relative overflow-hidden group">
                            <span class="relative z-10">ĐẶT HÀNG NGAY</span>
                            <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition"></div>
                        </button>

                        <a href="/store/products"
                            class="block text-center text-primary font-semibold py-4 border-2 border-primary rounded-xl hover:bg-primaryLight/20 transition mt-4">
                            ← Quay lại giỏ hàng
                        </a>

                        <div class="mt-8 text-center text-sm text-gray-500">
                            <i class="fas fa-shield-alt text-primary mr-2"></i>
                            Thanh toán an toàn • Giao nhanh 30 phút • Đổi trả dễ dàng
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }


</div>
@code {
    private List<CartItemDTO> checkoutItems = new();
    private OrderDTO? currentOrder = null;
    private List<PromotionDTO> promotions = new List<PromotionDTO>();
    List<OrderItemReponse> listOrderProducts = new();

    private PromotionDTO? promotion { get; set; }
    private bool isLoading = true;
    async Task ShowAlert(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }
    private void SetPaymentMethod(string method)
    {
        currentOrder.PaymentMethod = method.Trim();
    }

    // Chọn tính toán CurrentOrder
    void HandleSelect(PromotionDTO item)
    {
        if (currentOrder.Subtotal == 0)
        {
            JS.InvokeVoidAsync("alert",
            $"Hãy chọn sản phẩm để mua trước khi chọn khuyến mãi");

            return;

        }

        if (promotion?.Id == item.Id)
        {
            // Nếu chọn lại mã đang được áp dụng -> Hủy chọn
            ResetPromotionSelection();
            return;
        }
        decimal subtotal = currentOrder.Subtotal;
        var now = DateTime.Now;

        // Không đủ mức tối thiểu
        if (item.MinOrderAmount > 0 && subtotal < item.MinOrderAmount)
        {
            JS.InvokeVoidAsync("alert",
            $"Đơn hàng phải đạt tối thiểu {item.MinOrderAmount:N0}₫ để dùng mã này!");

            return;
        }

        // Chưa đến ngày bắt đầu
        if (item.StartDate != null && item.StartDate > now)
        {
            JS.InvokeVoidAsync("alert", "Mã giảm giá này chưa đến thời gian áp dụng!");
            ResetPromotionSelection();

            return;
        }

        // Đã hết hạn
        if (item.EndDate != null && item.EndDate < now)
        {
            JS.InvokeVoidAsync("alert", "Mã giảm giá này đã hết hạn!");
            ResetPromotionSelection();

            return;
        }

        // Hết lượt sử dụng
        if (item.UsageLimit != null && item.UsedCount >= item.UsageLimit)
        {
            JS.InvokeVoidAsync("alert", "Mã này đã hết lượt sử dụng!");
            ResetPromotionSelection();
            StateHasChanged();
            return;
        }

        // --- Nếu hợp lệ → AP MÃ ---
        promotion = item;

        decimal discountAmount = 0;

        if (item.Type == "percent")
        {
            discountAmount = Math.Floor((subtotal * item.Value) / 100);
        }
        else
        {
            discountAmount = item.Value;
        }


        // cập nhật order giống React
        currentOrder.PromotionId = item.Id;
        currentOrder.PromotionCode = item.Code;
        currentOrder.Discount = discountAmount;
        currentOrder.TotalAmount = subtotal - discountAmount;


    }
    void ResetPromotionSelection()
    {
        promotion = null;
        currentOrder.Discount = 0;
        currentOrder.TotalAmount = currentOrder.Subtotal;

    }

    // Tinh toán subtotal và totalamount
    private void CalculateOrderTotals()
    {
        decimal tongTien = checkoutItems.Sum(item => item.Total);



        // Cập nhật Subtotal (chỉ tiền hàng)
        currentOrder.Subtotal = tongTien;
        currentOrder.TotalAmount = tongTien;


    }



    protected override async Task OnInitializedAsync()
    {
        if (!await IsCustomerLoggedIn())
        {
            Navigation.NavigateTo("/store", forceLoad: true);
            return;
        }

        promotions = await _ordersClient.GetListActivePromotion();

        // Khởi tạo order mới (sẽ lấy Id/OrderNumber sau khi tạo thật sự)
        currentOrder = new OrderDTO
        {
            Status = "pending",
            PaymentMethod = "cash",
            PaymentStatus = "pending",
            Subtotal = 0,
            Discount = 0,
            TotalAmount = 0
        };

        // Load cart from local storage
        checkoutItems = await CartService.GetCartItems();

        // Apply selected items saved in localStorage (no ids in URL)
        var selectedIds = await LocalStorage.GetItemAsync<List<int>>("checkoutSelectedIds");
        if (selectedIds != null && selectedIds.Count > 0)
        {
            checkoutItems = checkoutItems.Where(x => selectedIds.Contains(x.ProductId)).ToList();
            await LocalStorage.RemoveItemAsync("checkoutSelectedIds");
        }

        // Auto-fill customer info if available (skip if token invalid)
        var profile = await MeClient.GetProfileAsync();
        if (profile != null)
        {
            currentOrder.CustomerName = profile.FullName ?? currentOrder.CustomerName;
            currentOrder.Email = profile.Email ?? currentOrder.Email;
            currentOrder.SoDienThoai = profile.Phone ?? currentOrder.SoDienThoai;
            currentOrder.DiaChiKhachHang = profile.Address ?? currentOrder.DiaChiKhachHang;
        }
        else
        {
            // If profile cannot be loaded (likely 401), redirect to login with return url
            var returnUrl = Navigation.ToBaseRelativePath(Navigation.Uri);
            Navigation.NavigateTo($"/login?returnUrl=/{returnUrl}", forceLoad: true);
            return;
        }

        CalculateOrderTotals();

        isLoading = false;
    }

    // Chuẩn bị dữ liệu để gửi lên db
    private List<OrderItemReponse> preparedListOrderItemResponse(List<CartItemDTO> list)
    {
        var listOrderItemReponse = new List<OrderItemReponse>();
        foreach (var item in list)
        {
            listOrderItemReponse.Add(new OrderItemReponse
            {
                id = item.ProductId,
                orderid = currentOrder.Id,
                qty = item.Quantity,
                price = item.Price,
                total = item.Total
            });
        }
        return listOrderItemReponse;
    }

    public ApplyPromotionRequest preparedPromotion(OrderDTO order)
    {
        return new ApplyPromotionRequest
        {
            PromotionId = order.PromotionId ?? 0,
            OrderId = order.Id,
            CustomerId = order.CustomerId

        };

    }

    public List<ReduceInventoryDto> preparedListReduceInventoryDto(List<OrderItemReponse> items)
    {
        var list = new List<ReduceInventoryDto>();
        foreach (var item in items)
        {
            list.Add(new ReduceInventoryDto
            {
                ProductId = item.id,
                Quantity = item.qty
            });
        }
        return list;

    }

    async Task createNewOrder()
    {
        if (currentOrder == null)
        {
            await ShowAlert("Khong the tao don, vui long tai lai trang.");
            return;
        }

        listOrderProducts = preparedListOrderItemResponse(checkoutItems);
        JS.InvokeVoidAsync("console.log", "Đơn hàng:", currentOrder);
        JS.InvokeVoidAsync("console.log", "Danh sách sản phẩm muốn mua:", listOrderProducts);

                var savedOrder = await _ordersClient.SaveFinalOrderAsync(currentOrder);
        if (savedOrder == null)
        {
            JS.InvokeVoidAsync("console.log", "Luu order bi loi");
            return;
        }
        currentOrder = savedOrder;

        listOrderProducts.ForEach(i => i.orderid = currentOrder.Id);
        bool result2 = await _ordersClient.SaveListOrderItem(listOrderProducts);
        if (result2 == false)
        {
            JS.InvokeVoidAsync("console.log", "Lưu danh sách item lỗi");
            return;
        }
        List<ReduceInventoryDto> reducelist = preparedListReduceInventoryDto(listOrderProducts);
        bool result3 = await _ordersClient.ReduceMultipleAsync(reducelist);
        if (result3 == false)
        {
            JS.InvokeVoidAsync("console.log", "Giảm list sản phẩm lỗi");
            return;
        }

        if (currentOrder.PromotionId != null)
        {
            // Apply Promotion
            ApplyPromotionRequest requesst = preparedPromotion(currentOrder);
            bool result4 = await _ordersClient.ApplyPromotionAsync(requesst);
            if (result4 == false)
            {
                JS.InvokeVoidAsync("console.log", "Apply khuyến mãi lỗi");
                return;
            }
        }

        PaymentResult paymentResult;
        if (currentOrder.PaymentMethod == "cash")
        {
            paymentResult = await _ordersClient.PayCashInOnlineOrderAsync(currentOrder.Id, currentOrder.TotalAmount);
            if (paymentResult.Success == false)
            {
                JS.InvokeVoidAsync("console.log", "Thanh toán ofline lỗi");
                return;
            }
            else
            {
                ShowAlert("Đã tạo đơn hàng thành công");

            }
        }
        else
        {
            paymentResult = await _ordersClient.PayWithMomoWitOnlineOrderAsync(currentOrder.Id, currentOrder.TotalAmount);
            if (paymentResult.Success == false)
            {
                JS.InvokeVoidAsync("console.log", $"Lỗi thanh toán MoMo: {paymentResult.Message}");
                return;
            }
            else
            {
                ShowAlert("Đã tạo đơn hàng thành công");


            }

        }

        var purchasedProductIds = listOrderProducts.Select(x => x.id).ToList();
        await CartService.RemovePurchasedItemsFromCart(purchasedProductIds);
        await GoToThankyou(currentOrder.Id.ToString());
    }

    private async Task GoToThankyou(string orderId)
    {
        Navigation.NavigateTo($"/store/thankyou?orderId={orderId}");
    }

    private async Task<bool> IsCustomerLoggedIn()
    {
        try
        {
            var token = await LocalStorage.GetItemAsStringAsync("authToken");
            if (string.IsNullOrWhiteSpace(token)) return false;
            var role = await LocalStorage.GetItemAsStringAsync("userRole");
            return string.Equals(role?.Trim('\"'), "customer", StringComparison.OrdinalIgnoreCase);
        }
        catch
        {
            return false;
        }
    }
}


