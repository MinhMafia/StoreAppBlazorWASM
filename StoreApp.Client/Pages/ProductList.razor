@page "/products"
@using StoreApp.Shared
@using System.Net.Http.Json
@using StoreApp.Client.Components.Product

@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IProductClientService ProductService

<PageTitle>Quản lý sản phẩm</PageTitle>

<!-- Notification Toast -->
@if (notification != null)
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
        <div class="toast show align-items-center text-white @GetNotificationClass()" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    @notification.Message
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => notification = null"></button>
            </div>
        </div>
    </div>
}

<div class="container-fluid mt-4">
    <div class="row">
        @* --- CỘT TRÁI: CHỨC NĂNG & BỘ LỌC --- *@
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear-fill"></i> Chức năng</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success w-100 mb-2" @onclick="() => OpenModal(ModalMode.Create)">
                        <i class="bi bi-plus-circle"></i> Thêm sản phẩm mới
                    </button>
                    
                    <button class="btn btn-info w-100 mb-3" @onclick="OpenImportModal">
                        <i class="bi bi-upload"></i> Import Excel
                    </button>

                    <hr />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tìm kiếm</label>
                        <input type="text" class="form-control" placeholder="Tên sản phẩm..." 
                               @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleSearch" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Danh mục</label>
                        <select class="form-select" @bind="selectedCategory">
                            <option value="">Tất cả danh mục</option>
                            @if (categories != null)
                            {
                                @foreach (var cat in categories)
                                {
                                    <option value="@cat.Id">@cat.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Nhà cung cấp</label>
                        <select class="form-select" @bind="selectedSupplier">
                            <option value="">Tất cả nhà cung cấp</option>
                            @if (suppliers != null)
                            {
                                @foreach (var sup in suppliers)
                                {
                                    <option value="@sup.Id">@sup.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Khoảng giá</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Min</span>
                            <input type="number" class="form-control" @bind="minPrice" />
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">Max</span>
                            <input type="number" class="form-control" @bind="maxPrice" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Trạng thái</label>
                        <select class="form-select" @bind="status">
                            <option value="">Tất cả</option>
                            <option value="active">Đang hoạt động</option>
                            <option value="inactive">Ngừng hoạt động</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Sắp xếp theo</label>
                        <select class="form-select" @bind="sortBy">
                            <option value="id">ID</option>
                            <option value="name">Tên sản phẩm</option>
                            <option value="price_asc">Giá tăng dần</option>
                            <option value="price_desc">Giá giảm dần</option>
                            <option value="created_at">Ngày tạo</option>
                        </select>
                    </div>

                    <button class="btn btn-primary w-100" @onclick="ApplyFilters">
                        <i class="bi bi-funnel"></i> Áp dụng bộ lọc
                    </button>
                    
                    <button class="btn btn-outline-secondary w-100 mt-2" @onclick="ResetFilters">
                        <i class="bi bi-arrow-clockwise"></i> Xóa lọc
                    </button>
                </div>
            </div>
        </div>

        @* --- CỘT PHẢI: BẢNG DỮ LIỆU --- *@
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-primary fw-bold">Danh sách sản phẩm</h5>
                    <span class="badge bg-info text-dark">Tổng: @totalItems sản phẩm</span>
                </div>
                <div class="card-body p-0">
                    @if (loading)
                    {
                        <div class="p-4 text-center">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Đang tải dữ liệu...</p>
                        </div>
                    }
                    else if (error != null)
                    {
                        <div class="p-4 text-center text-danger">
                            <i class="bi bi-exclamation-triangle display-4"></i>
                            <p class="mt-2">@error</p>
                            <button class="btn btn-primary" @onclick="LoadProducts">Thử lại</button>
                        </div>
                    }
                    else if (products == null || products.Count == 0)
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-box-seam display-4"></i>
                            <p class="mt-2">Không tìm thấy sản phẩm nào.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover table-striped align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th style="width: 80px;">Ảnh</th>
                                        <th>Tên sản phẩm</th>
                                        <th>SKU</th>
                                        <th>Danh mục</th>
                                        <th>Nhà cung cấp</th>
                                        <th class="text-end">Giá bán</th>
                                        <th class="text-center">Tồn kho</th>
                                        <th class="text-center">Trạng thái</th>
                                        <th class="text-center" style="width: 180px;">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var p in products)
                                    {
                                        <tr>
                                            <td>@p.Id</td>
                                            <td>
                                                <img src="@GetImageUrl(p.ImageUrl)" 
                                                     class="img-thumbnail" 
                                                     style="width: 50px; height: 50px; object-fit: cover;" 
                                                     alt="@p.ProductName" />
                                            </td>
                                            <td class="fw-bold">@p.ProductName</td>
                                            <td><small class="text-muted">@p.Sku</small></td>
                                            <td><small>@(p.Category?.Name ?? "—")</small></td>
                                            <td><small>@(p.Supplier?.Name ?? "—")</small></td>
                                            <td class="text-end text-danger fw-bold">
                                                @p.Price.ToString("N0") đ
                                            </td>
                                            <td class="text-center">
                                                @{
                                                    var qty = p.Inventory?.Quantity ?? 0;
                                                    var qtyClass = qty > 10 ? "text-success" : qty > 0 ? "text-warning" : "text-danger";
                                                }
                                                <span class="@qtyClass fw-bold">@qty</span>
                                            </td>
                                            <td class="text-center">
                                                @if (p.IsActive)
                                                {
                                                    <span class="badge bg-success">Hiện</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Ẩn</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-info me-1" @onclick="() => OpenModal(ModalMode.View, p)" title="Chi tiết">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => OpenModal(ModalMode.Edit, p)" title="Sửa">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteProduct(p.Id, p.IsActive)" title="@(p.IsActive ? "Xóa" : "Khôi phục")">
                                                    <i class="bi @(p.IsActive ? "bi-trash" : "bi-arrow-clockwise")"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
                
                <div class="card-footer bg-white d-flex justify-content-between align-items-center py-3">
                    <div>
                        <select class="form-select form-select-sm" style="width: 100px;" @bind="pageSize" @bind:after="OnPageSizeChanged">
                            <option value="5">5 / trang</option>
                            <option value="10">10 / trang</option>
                            <option value="20">20 / trang</option>
                            <option value="50">50 / trang</option>
                        </select>
                    </div>
                    
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                            </li>
                            
                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                            {
                                var pageNum = i;
                                <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                    <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                                </li>
                            }
                            
                            <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                                <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                    
                    <div class="text-muted small">
                        Trang @currentPage / @totalPages
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    @* Product Modals *@
    @if (modalState.IsOpen)
    {
        @if (modalState.Mode == ModalMode.View)
        {
            <ProductDetail 
                Product="@modalState.Product"
                OnCancel="@CloseModal"
                OnDelete="@((tuple) => DeleteProduct(tuple.Item1, tuple.Item2))"
                OnEdit="@((p) => OpenModal(ModalMode.Edit, p))" />
        }
        else if (modalState.Mode == ModalMode.Create)
        {
            <ProductAdd 
                Categories="@categories"
                Suppliers="@suppliers"
                Saving="@saving"
                OnSave="@((p) => HandleSave(p, ModalMode.Create))"
                OnCancel="@CloseModal" />
        }
        else if (modalState.Mode == ModalMode.Edit)
        {
            <ProductEdit 
                Product="@modalState.Product"
                Categories="@categories"
                Suppliers="@suppliers"
                Saving="@saving"
                OnSave="@((p) => HandleSave(p, ModalMode.Edit))"
                OnCancel="@CloseModal"
                OnDelete="@((tuple) => DeleteProduct(tuple.Item1, tuple.Item2))" />
        }
    }

@* Import Modal *@
@if (importModalOpen)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-upload"></i> Import sản phẩm từ Excel</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => importModalOpen = false"></button>
                </div>
                <div class="modal-body">
                    <p>Chức năng import Excel sẽ được phát triển sau.</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> Định dạng file: .xlsx, .xls
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => importModalOpen = false">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Enums
    private enum ModalMode { View, Create, Edit }
    
    // Data state
    private List<ProductDTO>? products;
    private List<CategoryDTO>? categories = new();
    private List<SupplierDTO>? suppliers = new();
    private int totalItems;
    private int totalPages = 1;

    // Filter state
    private int currentPage = 1;
    private int pageSize = 10;
    private string searchTerm = "";
    private string selectedCategory = "";
    private string selectedSupplier = "";
    private decimal? minPrice;
    private decimal? maxPrice;
    private string sortBy = "id";
    private string status = "";

    // UI state
    private bool loading = false;
    private string? error = null;
    private bool saving = false;
    private bool importModalOpen = false;
    
    // Modal state
    private (bool IsOpen, ModalMode Mode, ProductDTO? Product) modalState = (false, ModalMode.View, null);
    
    // Notification
    private NotificationModel? notification;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }

    private async Task LoadInitialData()
    {
        await Task.WhenAll(
            LoadProducts(),
            LoadCategories(),
            LoadSuppliers()
        );
    }

    private async Task LoadCategories()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<CategoryDTO>>("api/categories");
            categories = result ?? new();
        }
        catch { categories = new(); }
    }

    private async Task LoadSuppliers()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<SupplierDTO>>("api/suppliers");
            suppliers = result ?? new();
        }
        catch { suppliers = new(); }
    }

    private async Task LoadProducts()
    {
        loading = true;
        error = null;
        
        try
        {
            var result = await ProductService.GetProducts(currentPage, pageSize, searchTerm, minPrice, maxPrice);

            if (result != null)
            {
                products = result.Items.ToList();
                totalItems = result.TotalItems;
                totalPages = result.TotalPages;
            }
        }
        catch (Exception ex)
        {
            error = $"Lỗi tải dữ liệu: {ex.Message}";
            products = new();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task HandleSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 1;
            await LoadProducts();
        }
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadProducts();
    }

    private async Task ResetFilters()
    {
        searchTerm = "";
        selectedCategory = "";
        selectedSupplier = "";
        minPrice = null;
        maxPrice = null;
        sortBy = "id";
        status = "";
        currentPage = 1;
        await LoadProducts();
    }

    private async Task OnPageSizeChanged()
    {
        currentPage = 1;
        await LoadProducts();
    }

    private async Task ChangePage(int newPage)
    {
        if (newPage < 1 || newPage > totalPages) return;
        currentPage = newPage;
        await LoadProducts();
    }

    private void OpenModal(ModalMode mode, ProductDTO? product = null)
    {
        modalState = (true, mode, product);
    }

    private void CloseModal()
    {
        modalState = (false, ModalMode.View, null);
    }

    private void OpenImportModal()
    {
        importModalOpen = true;
    }

    private async Task HandleSave(ProductDTO product, ModalMode mode)
    {
        saving = true;
        try
        {
            if (mode == ModalMode.Create)
            {
                var response = await Http.PostAsJsonAsync("api/products", product);
                if (response.IsSuccessStatusCode)
                {
                    ShowNotification("Thêm sản phẩm thành công!", NotificationType.Success);
                    CloseModal();
                    await LoadProducts();
                }
                else
                {
                    ShowNotification("Thêm sản phẩm thất bại!", NotificationType.Error);
                }
            }
            else if (mode == ModalMode.Edit)
            {
                var response = await Http.PutAsJsonAsync($"api/products/{product.Id}", product);
                if (response.IsSuccessStatusCode)
                {
                    ShowNotification("Cập nhật sản phẩm thành công!", NotificationType.Success);
                    CloseModal();
                    await LoadProducts();
                }
                else
                {
                    ShowNotification("Cập nhật sản phẩm thất bại!", NotificationType.Error);
                }
            }
        }
        catch (Exception ex)
        {
            ShowNotification($"Lỗi: {ex.Message}", NotificationType.Error);
        }
        finally
        {
            saving = false;
        }
    }

    private async Task DeleteProduct(int id, bool isActive)
    {
        var action = isActive ? "xóa (vô hiệu hóa)" : "khôi phục";
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Bạn có chắc chắn muốn {action} sản phẩm này không?");
        
        if (confirmed)
        {
            bool isSuccess = await ProductService.DeleteProduct(id);

            if (isSuccess)
            {
                ShowNotification($"{(isActive ? "Xóa" : "Khôi phục")} sản phẩm thành công!", NotificationType.Success);
                await LoadProducts();
            }
            else
            {
                ShowNotification($"{(isActive ? "Xóa" : "Khôi phục")} sản phẩm thất bại!", NotificationType.Error);
            }
        }
    }

    private string GetImageUrl(string? imageUrl)
    {
        if (string.IsNullOrEmpty(imageUrl))
            return "/assets/images/products/default.jpg";
        
        if (imageUrl.StartsWith("http"))
            return imageUrl;
            
        return $"/assets/images/products/{imageUrl}";
    }

    // Notification helper
    private enum NotificationType { Success, Error, Info, Warning }
    private class NotificationModel
    {
        public string Message { get; set; } = "";
        public NotificationType Type { get; set; }
    }

    private void ShowNotification(string message, NotificationType type)
    {
        notification = new NotificationModel { Message = message, Type = type };
        
        // Auto hide after 3 seconds
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            await InvokeAsync(() =>
            {
                notification = null;
                StateHasChanged();
            });
        });
    }

    private string GetNotificationClass()
    {
        return notification?.Type switch
        {
            NotificationType.Success => "bg-success",
            NotificationType.Error => "bg-danger",
            NotificationType.Warning => "bg-warning",
            NotificationType.Info => "bg-info",
            _ => "bg-secondary"
        };
    }
}