@page "/categories"
@using StoreApp.Client.Components.Category
@using StoreApp.Shared
@inject ICategoryClientService CategoryService
@inject IJSRuntime JS

<div class="container py-4">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 fw-bold text-dark mb-0">Quản Lý Danh Mục</h1>
        <button type="button" class="btn btn-primary" @onclick="openAddModal">
            + Thêm Danh Mục
        </button>
    </div>

    <!-- Error (UI only) -->
    @* <div class="alert alert-danger border" role="alert">
        <strong>Lỗi:</strong> ...
    </div> *@

    <!-- Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
            <div class="card border border-success-subtle bg-success bg-opacity-10 h-100" role="button">
                <div class="card-body">
                    <div class="small text-success fw-semibold">Đang Hoạt Động</div>
                    <div class="fs-3 fw-bold text-success">@activeCount</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card border border-danger-subtle bg-danger bg-opacity-10 h-100" role="button">
                <div class="card-body">
                    <div class="small text-danger fw-semibold">Ngừng Hoạt Động</div>
                    <div class="fs-3 fw-bold text-danger">@inactiveCount</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row g-2 align-items-center mb-4">
        <div class="col-12 col-lg">
            <div class="input-group">
                <span class="input-group-text bg-white">
                    <!-- Search icon (Bootstrap Icons SVG inline) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                         class="bi bi-search text-secondary" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                    </svg>
                </span>
                <input class="form-control"
                       placeholder="Tìm kiếm theo tên danh mục, mô tả..."
                       @bind="searchKeyword"
                       @bind:event="oninput"
                       @onkeyup="HandleSearchKeyUp" />
            </div>
        </div>

        <div class="col-12 col-lg-auto">
            <button type="button" class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2" @onclick="SearchCategories">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                     class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                </svg>
                Tìm kiếm
            </button>
        </div>

        <div class="col-12 col-lg-auto">
            <select class="form-select w-100" @bind="selectedStatus" @bind:after="FilterByStatus">
                <option value="all">Tất Cả Trạng Thái</option>
                <option value="active">Đang Hoạt Động</option>
                <option value="inactive">Ngừng Hoạt Động</option>
            </select>
        </div>

        <div class="col-12 col-lg-auto">
            <button type="button" class="btn btn-secondary w-100 d-flex align-items-center justify-content-center gap-2"
                    title="Làm mới danh sách" @onclick="RefreshCategories">
                <!-- Rotate icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                     class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384l-2.36 1.966A.25.25 0 0 1 8 4.466"/>
                </svg>
                Làm Mới
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="card border">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-nowrap">Tên Danh Mục</th>
                        <th class="text-nowrap">Slug</th>
                        <th>Mô Tả</th>
                        <th class="text-nowrap">Trạng Thái</th>
                        <th class="text-center text-nowrap" style="width: 160px;">Hành Động</th>
                    </tr>
                </thead>

                <tbody>
                    @if (isLoading)
                    {
                        <tr>
                            <td colspan="5" class="text-center text-secondary py-4">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Đang tải...
                            </td>
                        </tr>
                    }
                    else if (categories == null || categories.Count == 0)
                    {
                        <tr>
                            <td colspan="5" class="text-center text-secondary py-4">
                                Không có danh mục nào
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var category in categories)
                        {
                            <tr>
                                <td>
                                    <div class="fw-semibold text-dark">@category.Name</div>
                                    <div class="small text-secondary">@category.CreatedAt.ToString("dd/MM/yyyy")</div>
                                </td>
                                <td class="text-secondary">@(category.Slug ?? "-")</td>
                                <td class="text-secondary">
                                    @(string.IsNullOrEmpty(category.Description) ? "-" : (category.Description.Length > 50 ? category.Description.Substring(0, 50) + "..." : category.Description))
                                </td>
                                <td>
                                    @if (category.IsActive)
                                    {
                                        <span class="badge rounded-pill text-bg-success">Hoạt Động</span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill text-bg-danger">Ngừng Hoạt Động</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="d-inline-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm" title="Xem chi tiết" @onclick="() => openDetailModal(category.Id)">
                                            <!-- Eye -->
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                 class="bi bi-eye" viewBox="0 0 16 16">
                                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
                                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M6.5 8a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0"/>
                                            </svg>
                                        </button>

                                        <button type="button" class="btn btn-outline-success btn-sm" title="Sửa" @onclick="() => openEditModal(category.Id)">
                                            <!-- Pencil -->
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                 class="bi bi-pencil-square" viewBox="0 0 16 16">
                                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293z"/>
                                                <path d="M13.752 4.396 11.354 2 4.939 8.415a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                                            </svg>
                                        </button>

                                        <button type="button" class="btn btn-outline-danger btn-sm" title="@(category.IsActive ? "Ngừng hoạt động" : "Kích hoạt")" @onclick="() => ToggleCategoryStatus(category.Id, !category.IsActive)">
                                            <!-- Power -->
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                 class="bi bi-power" viewBox="0 0 16 16">
                                                <path d="M7.5 1v7h1V1z"/>
                                                <path d="M3 8.812a4.999 4.999 0 0 1 2.578-4.375l.5.866A4 4 0 1 0 10 5.303l.5-.866A5 5 0 1 1 3 8.812"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mt-4">
        <nav aria-label="Pagination">
            <ul class="pagination mb-0">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" aria-label="Previous">«</button>
                </li>
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <button class="page-link" @onclick="() => ChangePage(i)">@i</button>
                    </li>
                }
                <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)" aria-label="Next">»</button>
                </li>
            </ul>
        </nav>

        <div class="text-secondary small">
            Hiển thị @((currentPage - 1) * pageSize + 1)-@(Math.Min(currentPage * pageSize, totalItems)) trên @totalItems danh mục
        </div>
    </div>

    <!-- Modals -->
    <CategoryDetailModal IsOpen="@showDetailModal" OnClose="closeDetailModal" CategoryId="@selectedCategoryId" />
    <CategoryEditModal IsOpen="@showEditModal" OnClose="closeEditModal" CategoryId="@selectedCategoryId" OnSave="HandleCategoryUpdated" />
    <CategoryAddModal IsOpen="@showAddModal" OnClose="closeAddModal" OnSave="HandleCategoryAdded" />

</div>

@code {
    // Modal states
    private bool showAddModal = false;
    private bool showDetailModal = false;
    private bool showEditModal = false;
    private int? selectedCategoryId = null;

    // Data
    private List<CategoryResponseDTO> categories = new();
    private bool isLoading = false;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalItems = 0;
    private int totalPages = 1;
    private string searchKeyword = "";
    private string selectedStatus = "all";
    private int activeCount = 0;
    private int inactiveCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        isLoading = true;
        try
        {
            var result = await CategoryService.GetCategories(currentPage, pageSize, 
                string.IsNullOrWhiteSpace(searchKeyword) ? null : searchKeyword,
                selectedStatus == "all" ? null : selectedStatus);
            
            categories = result.Items ?? new List<CategoryResponseDTO>();
            totalItems = result.TotalItems;
            totalPages = result.TotalPages;
            
            // Calculate statistics
            await CalculateStatistics();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi khi tải danh sách: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CalculateStatistics()
    {
        try
        {
            var activeResult = await CategoryService.GetCategories(1, 1, null, "active");
            activeCount = activeResult.TotalItems;
            
            var inactiveResult = await CategoryService.GetCategories(1, 1, null, "inactive");
            inactiveCount = inactiveResult.TotalItems;
        }
        catch
        {
            // Ignore errors in statistics
        }
    }

    private async Task SearchCategories()
    {
        currentPage = 1;
        await LoadCategories();
    }

    private async Task HandleSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchCategories();
        }
    }

    private async Task FilterByStatus()
    {
        currentPage = 1;
        await LoadCategories();
    }

    private async Task RefreshCategories()
    {
        searchKeyword = "";
        selectedStatus = "all";
        currentPage = 1;
        await LoadCategories();
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadCategories();
    }

    private async Task ToggleCategoryStatus(int id, bool newStatus)
    {
        var confirmMessage = newStatus ? "Bạn có chắc muốn kích hoạt danh mục này?" : "Bạn có chắc muốn ngừng hoạt động danh mục này?";
        var confirmed = await JS.InvokeAsync<bool>("confirm", confirmMessage);
        
        if (!confirmed) return;

        try
        {
            await CategoryService.UpdateCategoryStatus(id, newStatus);
            await LoadCategories();
            await JS.InvokeVoidAsync("alert", "Cập nhật trạng thái thành công!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private async Task HandleCategoryAdded()
    {
        await LoadCategories();
    }

    private async Task HandleCategoryUpdated()
    {
        await LoadCategories();
    }

    // Modal handlers
    private void openAddModal()
    {
        showAddModal = true;
    }

    private void closeAddModal()
    {
        showAddModal = false;
    }

    private void openDetailModal(int categoryId)
    {
        showDetailModal = true;
        selectedCategoryId = categoryId;
    }

    private void closeDetailModal()
    {
        showDetailModal = false;
        selectedCategoryId = null;
    }

    private void openEditModal(int categoryId)
    {
        showEditModal = true;
        selectedCategoryId = categoryId;
    }

    private void closeEditModal()
    {
        showEditModal = false;
        selectedCategoryId = null;
    }
}
