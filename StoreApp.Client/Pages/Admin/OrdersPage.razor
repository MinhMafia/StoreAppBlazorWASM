@page "/admin/orders"
@using StoreApp.Shared
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@using StoreApp.Client.Components.OrderPage
@using System.Text.Json
@inject IOrdersClientService _ordersClient


@inject IJSRuntime JS


<div class="max-w-8xl mx-auto p-4 sm:p-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div class="flex items-center gap-3 w-full sm:w-auto">
            <label class="text-sm font-bold text-gray-700 whitespace-nowrap">
                Lọc trạng thái:
            </label>
            <select @onchange="OnStatusChanged"
                class="px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary">
                <option value="">Tất cả trạng thái</option>
                <option value="pending">Chưa xử lý</option>
                <option value="paid">Đã thanh toán</option>
                <option value="completed">Hoàn thành</option>
                <option value="cancelled">Đã hủy</option>
            </select>
        </div>

        <button @onclick="CreateNewOrder"
            class="w-full sm:w-auto px-6 py-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg transition">
            Tạo Đơn Hàng Mới
        </button>
    </div>

    @* {/* Tìm kiếm */} *@
    <div class="flex gap-3 mb-4">
        <input type="text" @bind-value="searchKeyword"
            class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" />
        <button @onclick="SearchOrders"
            class="px-6 py-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-blue-700">
            Tìm kiếm
        </button>
    </div>

    <div class="flex gap-4 mb-6 w-full">

        <!-- Từ ngày -->
        <div class="flex flex-col flex-1">
            <label class="text-sm font-semibold text-gray-700 mb-1">Từ ngày</label>
            <input @bind-value="selectedStartDate" type="date" class="px-3 py-2.5 border border-gray-300 rounded-lg w-full
                        focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" />
        </div>

        <!-- Đến ngày -->
        <div class="flex flex-col flex-1">
            <label class="text-sm font-semibold text-gray-700 mb-1">Đến ngày</label>
            <input type="date" @bind-value="selectedEndDate" class="px-3 py-2.5 border border-gray-300 rounded-lg w-full
                        focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" />
        </div>

        <!-- Button có label ẩn để cân chiều cao -->
        <div class="flex flex-col">
            <label class="invisible mb-1">.</label>
            <button @onclick="FilterByDate" class="px-6 py-2.5 bg-purple-500 text-white rounded-lg font-bold 
                    hover:bg-blue-700 w-full">
                Lọc
            </button>
        </div>

    </div>






    @if (showOrderModel)
    {
        <OrderForm selectedProduct="@selectedProduct" promotion="@promotion" ListOrderProducts="@listOrderProducts"
            currentOrder="@currentOrder" ordersFormMode="@ordersFormMode" OnCloseOrdersForm="() => showOrderModel = false"
            OnOrderChanged="HandleOrderChanged" createNewOrder="createNewOrder" />
    }


    <OrderTable listOrders="@listOrders" currentPage="@currentPage" totalPages="@totalPages"
        ViewOrderDetail="ViewOrderDetail" onPageChange="@(page => OnPageChanged(page))" OnReload="ReloadOrders" />





</div>
@code {


    bool showOrderModel = false;

    string ordersFormMode = "create";

    OrderDTO? currentOrder = null;


    ProductDTO? selectedProduct = null;
    List<OrderItemReponse> listOrderProducts = new();

    PromotionDTO? promotion = null;


    List<OrderDTO> listOrders = new();

    int currentPage = 1;
    int pageSize = 10;
    int totalPages = 1;

    string selectedStatus = "";
    DateTime? selectedStartDate = null;
    DateTime? selectedEndDate = null;
    string searchKeyword = "";
    async Task LoadOrdersAdvanced()
    {
        var response = await _ordersClient.LoadOrdersAdvanced(
        currentPage,
        pageSize,
        selectedStatus,
        selectedStartDate,
        selectedEndDate,
        searchKeyword
        );

        listOrders = response.Items;
        totalPages = response.TotalPages;
    }

    async Task ViewOrderDetail(OrderDTO order)
    {
        currentOrder = order;
        ordersFormMode = "detail";
        listOrderProducts = await _ordersClient.GetOrderItemsByOrderIdAsync(order.Id);

        if (order.PromotionId != null)
        {
            promotion = await _ordersClient.GetPromotionByIdAsync(order.PromotionId.Value);
        }

        showOrderModel = true;
        StateHasChanged();
    }


    async Task ShowAlert(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }

    async Task OnStatusChanged(ChangeEventArgs e)
    {
        selectedStatus = e.Value?.ToString() ?? "";
        currentPage = 1;
        await LoadOrdersAdvanced();


    }


    async Task FilterByDate()
    {
        if (selectedStartDate != null && selectedEndDate != null && selectedStartDate > selectedEndDate)
        {

            await JS.InvokeVoidAsync("alert", "NgÃ y báº¯t Ä‘áº§u pháº£i nhá» hÆ¡n hoáº·c báº±ng ngÃ y káº¿t thÃºc. Vui lÃ²ng chá»n láº¡i.");
            return;
        }

        currentPage = 1;

        await LoadOrdersAdvanced();
    }


    async Task SearchOrders()
    {
        if (string.IsNullOrWhiteSpace(searchKeyword))
        {
            ShowAlert("Không để rỗng từ khóa tìm kiếm");
            return;
        }


        currentPage = 1;
        await LoadOrdersAdvanced();
    }

    async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadOrdersAdvanced();
    }
    private async Task ReloadOrders()
    {
        await LoadOrdersAdvanced();
    }


    // Hiển thị danh sách đơn hàng khi trang được tải
    protected override async Task OnInitializedAsync()
    {
        // Tải dữ liệu lần đầu ngay khi component được khởi tạo
        await LoadOrdersAdvanced();
    }

    // Tạo đơn hàng mới
    async Task CreateNewOrder()
    {
        ordersFormMode = "create";
        //Gọi một đơn tạm với server để lấy id đơn hàng mới
        currentOrder = await _ordersClient.CreateTemporaryOrderAsync();
        listOrderProducts.Clear();
        selectedProduct = null;
        promotion = null;
        showOrderModel = true;
    }

    void HandleOrderChanged(OrderDTO updatedOrder)
    {
        currentOrder = updatedOrder;

    }

    // Tạo đơn hàng mới
    async Task createNewOrder()
    {
        if (listOrderProducts.Count == 0)
        {
            ShowAlert("Vui lòng chọn sản phẩm để mua");
            return;

        }
        // In ra console.log của trình duyệt
        JS.InvokeVoidAsync("console.log", "Đơn hàng:", currentOrder);

        if (currentOrder.PaymentMethod == "cash")
        {
            currentOrder.Status = "completed";
        }


        var savedOrder = await _ordersClient.SaveFinalOrderAsync(currentOrder);
        if (savedOrder == null)
        {
            JS.InvokeVoidAsync("console.log", "Lưu order bị lỗi");
            return;
        }
        currentOrder = savedOrder;



        listOrderProducts?.ForEach(item => item.orderid = currentOrder.Id);
        JS.InvokeVoidAsync("console.log", "Danh sách sản phẩm mới mua:", listOrderProducts);
        bool result2 = await _ordersClient.SaveListOrderItem(listOrderProducts);
        if (result2 == false)
        {
            return;
        }
        List<ReduceInventoryDto> reducelist = preparedListReduceInventoryDto(listOrderProducts);
        bool result3 = await _ordersClient.ReduceMultipleAsync(reducelist);
        if (result3 == false)
        {
            return;
        }

        if (currentOrder.PromotionId != null)
        {
            // Apply Promotion
            ApplyPromotionRequest requesst = preparedPromotion(currentOrder);
            bool result4 = await _ordersClient.ApplyPromotionAsync(requesst);
            if (result4 == false)
            {
                return;
            }
        }

        PaymentResult paymentResult;
        if (currentOrder.PaymentMethod == "cash")
        {
            paymentResult = await _ordersClient.PayOfflineAsync(currentOrder.Id, currentOrder.TotalAmount);
            if (paymentResult.Success == false)
            {

                return;
            }
            else
            {
                ShowAlert("Đã tạo đơn hàng thành công");

            }
        }
        else
        {
            paymentResult = await _ordersClient.PayWithMomoAsync(currentOrder.Id, currentOrder.TotalAmount);
            if (paymentResult.Success == false)
            {
                JS.InvokeVoidAsync("console.log", $"Lỗi thanh toán MoMo: {paymentResult.Message}");
                return;
            }
            else
            {
                ShowAlert("Đã tạo đơn hàng thành công");

            }

        }
        bool wantPrint = await JS.InvokeAsync<bool>("confirm", "Bạn có muốn in hóa đơn không?");
        if (wantPrint)
        {
            await PrintInvoiceAsync(currentOrder, listOrderProducts);
        }

        showOrderModel = false;


    }



    // Chuáº©n bá»‹ ApplyPromotionRequest
    public ApplyPromotionRequest preparedPromotion(OrderDTO order)
    {
        return new ApplyPromotionRequest
        {
            PromotionId = order.PromotionId ?? 0,
            OrderId = order.Id,
            CustomerId = order.CustomerId

        };

    }

    public List<ReduceInventoryDto> preparedListReduceInventoryDto(List<OrderItemReponse> items)
    {
        List<ReduceInventoryDto> list = new List<ReduceInventoryDto>();
        foreach (var item in items)
        {
            list.Add(new ReduceInventoryDto
            {
                ProductId = item.id,
                Quantity = item.qty
            });
        }
        return list;

    }

    public async Task PrintInvoiceAsync(OrderDTO order, List<OrderItemReponse> items)
    {
        Func<decimal, string> fmt = (num) =>
        string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", num);

        string rows = "";
        foreach (var p in items)
        {
            rows += $@"
<tr>
<td style='text-align:left; padding-left:10px;'>{p.product}</td>
<td>{p.qty}</td>
<td>{fmt(p.price)}</td>
<td>{fmt(p.total)}</td>
</tr>";
        }

        string promotionHtml = "";
        if (!string.IsNullOrEmpty(order.PromotionCode))
        {
            promotionHtml = $@"
<div style='color:red; font-weight:bold; margin-top:5px;'>
Khuyáº¿n mÃ£i ({order.PromotionCode}): -{fmt(order.Discount)}
</div>";
        }

        string paymentHtml = order.PaymentMethod?.ToLower() switch
        {
            "cash" => "TIá»€N Máº¶T",
            "momo" => "MOMO",
            _ => (order.PaymentMethod ?? "cash").ToUpper()
        };

        string html = $@"
<!DOCTYPE html>
<html><head>
<meta charset='utf-8'>
<title>Hóa đơn #{order.OrderNumber ?? order.Id.ToString()}</title>

<style>
body {{ font-family: Arial, sans-serif; margin: 20px; font-size: 14px; }}
h2 {{ text-align: center; color: #1a9a7d; margin: 0 0 15px 0; }}
.info {{ margin: 4px 0; }}
table {{ width: 100%; border-collapse: collapse; margin: 15px 0; }}
th, td {{ border: 1px solid #000; padding: 8px; text-align: center; }}
th {{ background: #f0f0f0; }}
.total {{ text-align: right; font-weight: bold; font-size: 18px; margin-top: 10px; }}
.footer {{ margin-top: 40px; text-align: center; font-size: 18px; font-weight: bold; }}
</style>

</head><body>
<h2>PHIẾU THANH TOÁN</h2>

<div class='info'><strong>Mã đơn:</strong> #{order.OrderNumber ?? order.Id.ToString()}</div>
<div class='info'><strong>Khách hàng:</strong> {(order.CustomerName)}</div>
<div class='info'><strong>Thời gian:</strong> {DateTime.Now:dd/MM/yyyy HH:mm:ss}</div>
<table>
<tr><th>Sản phẩm</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th></tr>
{rows}
</table>

<div class='total'>TỔNG TIỀN: {fmt(order.TotalAmount)}</div>
{promotionHtml}

<div style='margin-top:15px; font-size:17px; font-weight:bold;'>
Thanh toán: {paymentHtml}
</div>

<div class='footer'>CẢM ƠN QUÝ KHÁCH!<br>HẸN GẶP LẠI</div>
</body></html>";

        string safeHtml = html.Replace("`", "\\`");

        string js = $@"
var iframe = document.createElement('iframe');
iframe.style.position = 'fixed';
iframe.style.right = '0';
iframe.style.bottom = '0';
iframe.style.width = '0';
iframe.style.height = '0';
iframe.style.border = 'none';
document.body.appendChild(iframe);

var doc = iframe.contentWindow.document;
doc.open();
doc.write(`{safeHtml}`);
doc.close();
iframe.contentWindow.focus();
iframe.contentWindow.print();

iframe.contentWindow.onafterprint = () => document.body.removeChild(iframe);
";

        await JS.InvokeVoidAsync("eval", js);
    }










}