@page "/admin/audit"
@using StoreApp.Client.Components.Audit
@using StoreApp.Shared
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@using StoreApp.Client.Components.OrderPage
@using System.Text.Json

@inject IJSRuntime JS
@inject IAuditClientService AuditClientService
<div class="max-w-7xl mx-auto p-4 sm:p-6">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Nhật Ký Hoạt Động (Audit Log)
        </h1>
        <p class="text-gray-600 mt-1">
            Theo dõi mọi thao tác của nhân viên trong hệ thống
        </p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-5 mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 ">
                    Nhân Viên
                </label>
                <select
                    @bind="selectedUser"
                    class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">-- Tất cả nhân viên --</option>
                    @foreach (var user in listuser)
                    {
                        <option value="@user.Id">@user.FullName</option>
                    }
                </select>


            </div>
          
            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1">
                    Ngày Bắt Đầu
                </label>
                <input type="date"
                @bind-value:format="yyyy-MM-dd"
                @bind-value="selectedStartDate" 
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                />
            </div>

          
            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1">
                    Ngày Kết Thúc
                </label>
                <input type="date"
                @bind-value:format="yyyy-MM-dd"
                @bind-value="selectedEndDate"  
                class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                />
            </div>


         
            <div class="flex items-end">
                <button 
                    @onclick="OnFilter"
                    class="w-full px-6 py-2.5 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">
                    Lọc
                </button>
            </div>
        </div>

    </div>

    <AuditTable 
        ViewDetail="@ViewDetail"
        currentPage="@currentPage"
        totalPages="@totalPages"
        listLog="@listLog"
        ChangePage="@ChangePage"
    />
    @if(showDetail){
        <AuditDetail
        currentLog="@currentLog" 
        onClose="@OnClose"
        />
    }
    

</div>

@code{
    bool showDetail = false;
    int currentPage = 1;
    int pageSize = 10;
    int totalPages = 1;

    int? selectedUser = null;
    DateTime? selectedStartDate = null;
    DateTime? selectedEndDate = null;

    // List user
    List<UserDTO> listuser = new List<UserDTO>();

    // List Log
    List <ActivityLogCreateDTO> listLog = new List<ActivityLogCreateDTO>(); 

    // Log đang được chọn
    ActivityLogCreateDTO? currentLog = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        await LoadLogs();
    }

    // Lấy danh sách user
    private async Task LoadUsers()
    {
        listuser = await AuditClientService.GetAllUsersAsync();
    }
    // Lấy danh sách log có phân trang 
    private async Task LoadLogs()
    {
        try
        {
            var result = await AuditClientService.GetFilteredLogsAsync(
                currentPage, pageSize, selectedUser,
                selectedStartDate, selectedEndDate);

            listLog = result.Items;
            totalPages = result.TotalPages;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }

        // Nhấn nút Lọc
    private async Task OnFilter()
    {
        if (selectedStartDate != null && selectedEndDate != null && selectedStartDate > selectedEndDate)
        {

            await JS.InvokeVoidAsync("alert", "Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc.");
            return;
        }
        currentPage = 1; // reset page
        await LoadLogs();
    }

    // Hàm chuyển trang
    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        await LoadLogs();
    }

    // Hàm xem chi tiết Log

    private void ViewDetail(ActivityLogCreateDTO log)
    {
        currentLog=log;
        showDetail=true;
    }

    private void OnClose()
    {
        showDetail = false;
    }
}